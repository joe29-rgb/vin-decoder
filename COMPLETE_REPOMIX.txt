This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/**/*.ts, src/**/*.js, package.json, tsconfig.json, README.md, MASTER-LENDER-DATA-FILE_md
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
MASTER-LENDER-DATA-FILE_md
package.json
src/api/ghl-client.ts
src/api/middleware.ts
src/api/routes/deals.ts
src/api/routes/inventory.ts
src/api/routes/scrape.ts
src/api/routes/webhooks.ts
src/api/state.ts
src/config/config.ts
src/modules/aftermarket-products.ts
src/modules/approvals-engine.ts
src/modules/compliance-validator.ts
src/modules/deal-maximizer.ts
src/modules/ghl-integration.ts
src/modules/inventory-manager.ts
src/modules/lender-programs.ts
src/modules/payment-calculator.ts
src/modules/rules-library.ts
src/modules/supabase.ts
src/modules/tax-calculator.ts
src/modules/trade-in-equity.ts
src/modules/vin-decoder.ts
src/public/dashboard.js
src/server.ts
src/tests/all.test.ts
src/types/ambient.d.ts
src/types/pdf-parse.d.ts
src/types/types.ts
src/utils/logger.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="MASTER-LENDER-DATA-FILE_md">
CANADIAN AUTOMOTIVE LENDERS - COMPLETE MASTER GUIDE
Last Updated: January 4, 2026
Status: Production Ready
Total Lenders: 11 | Total Programs: 46+

TABLE OF CONTENTS
TD AUTO FINANCE

RBC AUTO FINANCE

NATIONAL BANK OF CANADA

CIBC AUTO FINANCE

AUTOCAPITAL CANADA

EDEN PARK INC

RIFCO

LENDCARE

IA AUTO FINANCE

GENERAL BANK OF CANADA

NORTHLAKE FINANCIAL

TD AUTO FINANCE
2-Key Program (Prime - Excellent Credit)
Rate Range: 0.00% - 3.99%

FICO Score: 720+

Front-End LTV: 110% | All-In LTV: 110%

Max DSR: 40% | Max Term: 96 months

Min Income: $24,000/year

Dealer Reserve: Variable by rate

Chargeback Days: Not specified

Term Caps by Year:

2024-2026: 96 months

2020-2023: 84 months

2015-2019: 72 months

2010-2014: 60 months

Pre-2010: Case-by-case

3-Key Program (Prime - Good Credit)
Rate Range: 4.00% - 5.99%

FICO Score: 680-719

Front-End LTV: 105% | All-In LTV: 110%

Max DSR: 40% | Max Term: 84 months

Min Income: $24,000/year

4-Key Program (Near-Prime - Fair Credit)
Rate Range: 6.00% - 8.99%

FICO Score: 620-679

Front-End LTV: 100% | All-In LTV: 105%

Max DSR: 40% | Max Term: 84 months

Min Income: $24,000/year

5-Key Program (Subprime)
Rate Range: 9.00% - 14.99%

FICO Score: 300-619

Front-End LTV: 90% | All-In LTV: 100%

Max DSR: 40% | Max Term: 72 months

Min Income: $18,000/year

RBC AUTO FINANCE
Auto Special - 30Oct25
Rate Range: 6.45% - 9.99%

Front-End LTV: See standard grid

All-In LTV: See standard grid

Max Term: 96 months

Min FICO: 650+

Min Income: $25,000/year

Quality Bonus: $1,300

Chargeback Days: 180

Reserve Grid: APR-based origination fee matrix (see rate sheet)

Term Caps by Year:
2024-2026: 96 months

2020-2023: 84 months

2015-2019: 72 months

2010-2014: 60 months

Pre-2010: 48 months

NATIONAL BANK OF CANADA
Standard Fixed Rate Program
Quality Bonus Schedule:

$7,500-$12,499: $500

$12,500-$19,999: $625

$20,000-$24,999: $1,200

$25,000+: $1,200

No Cap on Reserves (unlimited)

Chargeback Days: 180

Reserve Grids: Fixed rate reserves by APR and term

Term Caps by Year:
2023-2026: 96 months

2020-2022: 84 months

2019: 72 months

2018: 60 months

2017: 48 months

2015-2016: 36 months

EV Special Program
Rate: Up to 6.74%

Eligible Vehicles: HEV, PHEV, BEV, FCEV (2015+)

Quality Bonus: $1,200

Max Term: 96 months

Chargeback Days: 180

CIBC AUTO FINANCE
2023-2026 Vehicle Program
Rate Range: 7.29% - 9.49%

Quality Bonus:

$20,000+: $1,200

Under $20,000: $600

Chargeback Days: 180

Term: 96 months (2023-2026)

Reserve Grid: Multi-dimensional (APR × Term × Financed Amount)

2018-2022 Vehicle Program
Rate Range: 7.49% - 9.49%

Quality Bonus: Same as above

Term Caps:

2021-2022: 84 months

2019-2020: 72 months

2018: 60 months

2018+ (<60 Months) Vehicle Program
Rate Range: 7.99% - 8.99%

Term Bands: 48-54 months

2015-2017 Vehicle Program
Rate Range: 8.49% - 9.49%

Term Bands: 36-48 months

Term Caps:

2017: 48 months

2015-2016: 36 months

Green Vehicle Special (EV Program)
Rate: 6.52%

Eligible: HEV, PHEV, BEV, FCEV

Quality Bonus: $1,200 (min $20,000 financed)

Min Model Year: 2023

Max Term: 96 months

Reserve: 0.25%

Special: CIBC donates $25 to Nature Conservancy of Canada per loan

10-Year Anniversary Franchise Special
Rate (2024-2026): 6.49%

Rate (2022-2026): 6.79%

Rate Discount: 0.10%

Quality Bonus: $1,200

Min Financed: $20,000

New/Demo Only

Term Caps:

2023-2025: 96 months

2022: 84 months

AUTOCAPITAL CANADA
General Parameters
Unlimited Front-End Advance & LTV on loans ≤$13,500 (all tiers)

Chargeback Days: 90 days

New 2024-2025 Models: 125% MSRP advance (110% if mileage > 10,000 km)

Admin Fee: $799 (all tiers)

Dealer Reserve: $300 (up to $15,000) | $500 ($15,000+)

Tier 1 - Best Prime
Rate From: 13.49%

Front-End Advance: 140% | All-In LTV: 175%

Max DSR: 55% | Max Term: 84 months

Tier 2 - Strong Prime
Rate From: 14.49%

Front-End Advance: 140% | All-In LTV: 175%

Max DSR: 55% | Max Term: 84 months

Tier 3 - Prime
Rate From: 15.99%

Front-End Advance: 140% | All-In LTV: 165%

Max DSR: 50% | Max Term: 84 months

Tier 4 - Near-Prime
Rate From: 17.99%

Front-End Advance: 135% | All-In LTV: 165%

Max DSR: 47% | Max Term: 84 months

Tier 5 - Subprime
Rate From: 21.49%

Front-End Advance: 135% | All-In LTV: 150%

Max DSR: 43% | Max Term: 78 months

Tier 6 - High Risk
Rate From: 23.49%

Front-End Advance: 130% | All-In LTV: 150%

Max DSR: 43% | Max Term: 72 months

Term Caps by Year and Condition:
2025 Model Year:

Extra Clean (0-40k km): 84 months

Clean (40,001-65k km): 84 months

Average (65,001-95k km): 84 months

Rough (95,001-115k km): 84 months

2024 Model Year:

Extra Clean (0-65k km): 84 months

Clean (65,001-95k km): 84 months

Average (95,001-135k km): 84 months

Rough (135,001-195k km): 78 months

2023 Model Year:

Extra Clean (0-80k km): 84 months

Clean (80,001-115k km): 84 months

Average (115,001-155k km): 84 months

Rough (155,001-195k km): 72 months

2022 Model Year:

Extra Clean (0-90k km): 84 months

Clean (90,001-120k km): 84 months

Average (120,001-155k km): 78 months

Rough (155,001-195k km): 66 months

2021 Model Year:

Extra Clean (0-100k km): 84 months

Clean (100,001-135k km): 84 months

Average (135,001-175k km): 78 months

Rough (175,001-195k km): 66 months

2020 Model Year:

Extra Clean (0-105k km): 84 months

Clean (105,001-140k km): 84 months

Average (140,001-175k km): 72 months

Rough (175,001-195k km): 66 months

2019 Model Year:

Extra Clean (0-115k km): 78 months

Clean (115,001-145k km): 72 months

Average (145,001-175k km): 66 months

Rough (175,001-195k km): 54 months

2018 Model Year:

Clean (0-155k km): 66 months

Average (155,001-175k km): 60 months

Rough (175,001-195k km): 54 months

2017 Model Year:

Clean (0-155k km): 54 months

Average (155,001-175k km): 54 months

Rough (175,001-190k km): 48 months

2016 Model Year:

Clean (0-155k km): 42 months

Average (155,001-170k km): 42 months

Rough (170,001-190k km): 36 months

2015 Model Year:

Clean (0-155k km): 30 months

Average (155,001-170k km): 30 months

Rough (170,001-190k km): 24 months

EDEN PARK INC
Ride Program Tiers
6 Ride (Best Tier)

Rate From: 11.99%

Front-End Advance: 140%

Max Term: 84 months

Max Payment Call: $950

5 Ride

Rate From: 13.99%

Front-End Advance: 140%

Max Term: 84 months

4 Ride

Rate From: 16.99%

Front-End Advance: 140%

Max Term: 84 months

3 Ride

Rate From: 19.99%

Front-End Advance: 135%

Max Term: 84 months

2 Ride

Rate From: 23.99%

Front-End Advance: 130%

Max Term: 84 months

EP Ride+ (Premium Program)

Rate From: 11.99%

Front-End Advance: 140%

Max Term: 84 months

EP No Hit

Rate From: 19.99%

Front-End Advance: 130%

Max Term: 84 months

Dealer Reserve Schedule
Up to $10,000: $250

$10,001-$15,000: $300

$15,001-$20,000: $450

$20,001-$25,000: $500

$25,001-$45,000: $600

$45,001+: $750

General Terms
Chargeback Days: 180

New 2026-2024 <5k km: 125% MSRP (84 months)

New 2026-2024 >5k km: 110% MSRP (84 months)

Term Caps by Year and Condition:
2025/2026:

Extra Clean (5,001-40k km): 84 months

Clean (40,001-65k km): 84 months

Average (65,001-95k km): 84 months

Rough (95,001-120k km): 84 months

2024:

Extra Clean (0-68k km): 84 months

Clean (68,001-100k km): 84 months

Average (100,001-130k km): 84 months

Rough (130,001-180k km): 72 months

2023:

Extra Clean (0-78k km): 84 months

Clean (78,001-125k km): 84 months

Average (125,001-150k km): 78 months

Rough (150,001-180k km): 66 months

2022:

Extra Clean (0-85k km): 84 months

Clean (85,001-125k km): 84 months

Average (125,001-150k km): 78 months

Rough (150,001-180k km): 66 months

2021:

Extra Clean (0-95k km): 84 months

Clean (95,001-130k km): 84 months

Average (130,001-160k km): 72 months

Rough (160,001-180k km): 66 months

2020:

Extra Clean (0-95k km): 84 months

Clean (95,001-120k km): 84 months

Average (120,001-170k km): 72 months

Rough (170,001-180k km): 66 months

2019:

Extra Clean (0-110k km): 78 months

Clean (110,001-135k km): 72 months

Average (135,001-170k km): 60 months

Rough (170,001-180k km): 54 months

2018:

Extra Clean (0-110k km): 72 months

Clean (110,001-130k km): 66 months

Average (130,001-170k km): 54 months

Rough (170,001-180k km): 48 months

2017:

Clean (0-145k km): 48 months

Average (145,001-165k km): 48 months

Rough (165,001-180k km): 36 months

2016:

Clean (0-145k km): 48 months

Average (145,001-165k km): 42 months

Rough (165,001-180k km): 24 months

2015:

Clean (0-145k km): 36 months

Average (145,001-165k km): 36 months

Rough (165,001-180k km): 12 months

RIFCO
All-Access Preferred Program
Tier 1 (Best)

Rate From: 9.95%

Front-End LTV: 140%

All-In LTV: 155%

Dealer Reserve: $1,200

Max Term: 84 months

Tier 2

Rate From: 12.95%

Dealer Reserve: $1,100

Tier 3

Rate From: 15.95%

Dealer Reserve: $1,000

Tier 4

Rate From: 18.95%

Front-End LTV: 135%

Dealer Reserve: $900

Tier 5

Rate From: 22.95%

Front-End LTV: 130%

Dealer Reserve: $800

Tier 6

Rate From: 25.95%

Dealer Reserve: $700

THIN (Limited/No Credit History)

Rate From: 28.95%

Front-End LTV: 125%

All-In LTV: 155%

Dealer Reserve: Base 2% up to max

Standard Program
Preferred Variant

Rate From: 29.95%

Front-End LTV: 130%

All-In LTV: 155%

Max Payment Call: $3,000

Dealer Reserve: $250

Standard Variant

Rate From: 29.95%

Dealer Reserve: $300

Drive Plan Variant

Rate From: 29.95%

Required Device: Starter Interrupter + GPS (PASSTIME)

GPS Provider Login: https://oasis.passtimeusa.com/login

General Terms
Loan Fee: $395

Device Fee: $595

Min Income: $3,000/month

Max Contract APR: 32%

Min Financing: $10,000

Chargeback Days: Not specified

Term Caps by Year and Mileage:
2022-2026:

0-24k km: 84 months

24,001-48k km: 84 months

48,001-72k km: 84 months

72,001-96k km: 84 months

96,001-120k km: 78 months

120,001-144k km: 72 months

144,001-168k km: 60 months

2021:

0-24k km: 84 months

24,001-48k km: 84 months

48,001-72k km: 84 months

72,001-96k km: 72 months

96,001-120k km: 72 months

120,001-144k km: 66 months

144,001-168k km: 60 months

2020:

0-24k km: 84 months

24,001-48k km: 84 months

48,001-72k km: 84 months

72,001-96k km: 72 months

96,001-120k km: 72 months

120,001-144k km: 66 months

144,001-168k km: 60 months

2019:

0-24k km: 78 months

24,001-48k km: 72 months

48,001-72k km: 72 months

72,001-96k km: 66 months

96,001-120k km: 60 months

120,001-144k km: 60 months

144,001-168k km: 54 months

2018:

0-24k km: 72 months

24,001-48k km: 66 months

48,001-72k km: 60 months

72,001-96k km: 60 months

96,001-120k km: 54 months

120,001-144k km: 54 months

144,001-168k km: 48 months

2017:

0-24k km: 66 months

24,001-48k km: 54 months

48,001-72k km: 54 months

72,001-96k km: 48 months

96,001-120k km: 48 months

120,001-144k km: 48 months

144,001-168k km: 42 months

2016:

0-24k km: 54 months

24,001-48k km: 42 months

48,001-72k km: 42 months

72,001-96k km: 36 months

96,001-120k km: 36 months

120,001-144k km: 36 months

144,001-168k km: 30 months

2015:

0-24k km: 54 months

24,001-48k km: 30 months

48,001-72k km: 30 months

72,001-96k km: 24 months

96,001-120k km: 24 months

120,001-144k km: 24 months

144,001-168k km: 24 months

LENDCARE
All-Access Preferred Program
Rate Range: 12.95% - 29.95%

Front-End LTV: 140%

All-In LTV: 155%

Min Income: $3,000/month

Max Term: 84 months

Term Caps by Year and Mileage:
2022-2026:

0-24k km: 84 months

24,001-48k km: 84 months

48,001-72k km: 84 months

72,001-96k km: 84 months

96,001-120k km: 84 months

120,001-144k km: 78 months

144,001-168k km: 72 months

2021:

0-24k km: 78 months

24,001-48k km: 72 months

48,001-72k km: 72 months

72,001-96k km: 72 months

96,001-120k km: 72 months

120,001-144k km: 72 months

144,001-168k km: 66 months

2020:

0-24k km: 72 months

24,001-48k km: 72 months

48,001-72k km: 72 months

72,001-96k km: 72 months

96,001-120k km: 72 months

120,001-144k km: 66 months

144,001-168k km: 60 months

2019:

0-24k km: 66 months

24,001-48k km: 66 months

48,001-72k km: 66 months

72,001-96k km: 66 months

96,001-120k km: 60 months

120,001-144k km: 60 months

144,001-168k km: 60 months

2018:

0-24k km: 60 months

24,001-48k km: 60 months

48,001-72k km: 60 months

72,001-96k km: 60 months

96,001-120k km: 54 months

120,001-144k km: 54 months

144,001-168k km: 54 months

IA AUTO FINANCE
Gear Programs
6 Gear (Prime)

Rate From: 11.49%

Front-End Advance: 140%

New Vehicle: $60,000+

Max Payment: $1,000

Max Term: 84 months

5 Gear

Rate From: 15.49%

Front-End Advance: 140%

4 Gear

Rate From: 20.49%

Front-End Advance: 135%

3 Gear

Rate From: 25.49%

Front-End Advance: 125%

2 Gear

Rate From: 29.99%

Front-End Advance: 125%

1 Gear

Rate From: 29.99%

Front-End Advance: 110%

Dealer Reserve Schedule
$50,000+: $1,000

$45,001-$50,000: $750

$35,001-$45,000: $600

$20,001-$35,000: $500

$15,001-$20,000: $450

$10,001-$15,000: $300

Under $10,000: $100

General Terms
Admin Fee: $699

Max Vehicle Mileage: 140,000 km

Max Term: 84 months

Features: Bankruptcy/Proposal program, Rate Reducing Loan

Term Caps by Year and Condition:
2025/2026:

Extra Clean (0-35k km): 84 months

Clean (35,001-60k km): 84 months

Average (60,001-90k km): 84 months

Rough (90,001-120k km): 84 months

2024:

Extra Clean (0-65k km): 84 months

Clean (65,001-95k km): 84 months

Average (95,001-120k km): 84 months

Rough (120,001-180k km): 72 months

2023:

Extra Clean (0-75k km): 84 months

Clean (75,001-120k km): 84 months

Average (120,001-150k km): 78 months

Rough (150,001-180k km): 66 months

2022:

Extra Clean (0-80k km): 84 months

Clean (80,001-120k km): 84 months

Average (120,001-150k km): 78 months

Rough (150,001-180k km): 66 months

2021:

Extra Clean (0-90k km): 84 months

Clean (90,001-120k km): 84 months

Average (120,001-150k km): 78 months

Rough (150,001-180k km): 66 months

2020:

Extra Clean (0-90k km): 84 months

Clean (90,001-120k km): 78 months

Average (120,001-165k km): 72 months

Rough (165,001-180k km): 54 months

2019:

Extra Clean (0-90k km): 78 months

Clean (90,001-120k km): 72 months

Average (120,001-165k km): 66 months

Rough (165,001-180k km): 54 months

2018:

Extra Clean (0-90k km): 78 months

Clean (90,001-120k km): 72 months

Average (120,001-165k km): 60 months

Rough (165,001-180k km): 54 months

2017:

No Book Value

Clean (0-120k km): 60 months

Average (120,001-165k km): 54 months

Rough (165,001-180k km): 30 months

2016:

No Book Value

Clean (0-120k km): 48 months

Average (120,001-165k km): 42 months

Rough (165,001-180k km): 30 months

2015:

No Book Value

Clean (0-120k km): 48 months

Average (120,001-165k km): 42 months

Rough (165,001-180k km): 30 months

GENERAL BANK OF CANADA
Standard Program (2017-2026)
Rate Range: 7.49% - 9.99%

Quality Bonus:

$50,000+: $1,300

$40,000-$49,999: $1,200

$30,000-$39,999: $1,200

$25,000-$29,999: $800

$15,000-$24,999: $400

Max Term: 96 months*

Max Financing: $150,000

Chargeback Days: 180

Note: 96 months only available on ATF > $20,000

New & Nearly New Winter Special (2021-2026)
Rate Range: 5.99% - 8.99%

Guaranteed Bonus:

$60,000+: $1,300

$50,000-$59,999: $1,300

$40,000-$49,999: $1,200

$35,000-$39,999: $1,200

$30,000-$34,999: $1,200

Max Term: 96 months

General Terms
No Cap on Dealer Reserve

Approvals Valid: 30 days from approval | 90 days if factory ordered

NORTHLAKE FINANCIAL
Full Spectrum Finance Programs (No minimum FICO requirement)
Unique Approach: Evaluates all factors holistically

Rate Range: 6.99% - 29.99%

Front-End LTV: 140%

All-In LTV: 155%

Max DSR: 50% (most flexible)

Min Income: $1,500-$2,000/month

Max Term: 84 months

Approval Timeline: Same-day possible

Rate Guarantee: 30 days from approval

Approval Valid: 90 days from approval

Term Caps by Year and Mileage:
2022-2026:

0-24k km: 84 months

24,001-48k km: 84 months

48,001-72k km: 84 months

72,001-96k km: 84 months

96,001-120k km: 78 months

120,001-144k km: 72 months

144,001-168k km: 60 months

2015-2021:

0-50k km: 72-84 months (varies)

50,001-100k km: 60-72 months

100,001-150k km: 48-60 months

150,001-180k km: 36-48 months

QUICK REFERENCE COMPARISON TABLE
Lender	Best Rate	Worst Rate	Max LTV	Max DSR	Max Term	Min FICO
TD 2-Key	0.00%	3.99%	110%	40%	96m	720+
TD 3-Key	4.00%	5.99%	110%	40%	84m	680-719
RBC Auto	6.45%	9.99%	See grid	See grid	96m	650+
National Bank	6.74%	Varies	Varies	Varies	96m	None
CIBC Green	6.49%	6.52%	Varies	Varies	96m	Varies
CIBC Standard	7.29%	9.49%	Varies	Varies	96m	Varies
General Bank	5.99%	9.99%	Varies	Varies	96m	Varies
Rifco AA T1	9.95%	9.95%	155%	Varies	84m	None
Eden Park 6R	11.99%	11.99%	Varies	Varies	84m	Varies
AutoCapital T1	13.49%	13.49%	175%	55%	84m	Varies
Rifco Std	29.95%	29.95%	155%	Varies	84m	None
IA Auto	11.49%	29.99%	140%	Varies	84m	Varies
NorthLake	6.99%	29.99%	155%	50%	84m	NONE
KEY TAKEAWAYS
Best for Prime Credit (720+): TD 2-Key (0.00% start), RBC Auto, CIBC programs
Best for Near-Prime (650-700): Santander, RBC Auto, National Bank, Eden Park
Best for Subprime (300-619): Rifco, IA Auto, NorthLake, AutoCapital
Fastest Approvals: NorthLake (same-day possible)
Highest LTV: AutoCapital (175% all-in on Tiers 1-2)
Most Flexible DSR: AutoCapital Tier 1 (55%), NorthLake (50%)
Best Quality Bonuses: Eden Park, Rifco, General Bank ($1,300 max)
Strictest Chargeback: AutoCapital (90 days)
Most Flexible Chargeback: RBC, National Bank, Eden Park (180 days)

{
  "metadata": {
    "last_updated": "January 4, 2026",
    "total_lenders": 11,
    "total_programs": 46,
    "source": "Official lender rate guides and program documentation"
  },
  "lenders": [
    {
      "lender_name": "TD AUTO FINANCE",
      "lender_code": "TD",
      "contact": {
        "credit": "1-855-TD AUTO1",
        "funding": "DealerServices@Servus.ca"
      },
      "programs": [
        {
          "program_id": "TD_2KEY",
          "program_name": "2-Key Program (Prime - Excellent Credit)",
          "rates": {
            "min": 0.0,
            "max": 3.99
          },
          "credit_range": {
            "min_fico": 720,
            "max_fico": 850
          },
          "ltv": {
            "front_end": 110,
            "all_in": 110
          },
          "dsr": {
            "max": 40
          },
          "term": {
            "min": 24,
            "max": 96
          },
          "income": {
            "minimum": 24000
          },
          "dealer_reserve": "Variable by rate",
          "chargeback_days": null,
          "term_caps_by_year": {
            "2024-2026": 96,
            "2020-2023": 84,
            "2015-2019": 72,
            "2010-2014": 60,
            "pre-2010": "Case-by-case"
          }
        },
        {
          "program_id": "TD_3KEY",
          "program_name": "3-Key Program (Prime - Good Credit)",
          "rates": {
            "min": 4.0,
            "max": 5.99
          },
          "credit_range": {
            "min_fico": 680,
            "max_fico": 719
          },
          "ltv": {
            "front_end": 105,
            "all_in": 110
          },
          "dsr": {
            "max": 40
          },
          "term": {
            "min": 24,
            "max": 84
          },
          "income": {
            "minimum": 24000
          },
          "term_caps_by_year": {
            "2024-2026": 96,
            "2020-2023": 84,
            "2015-2019": 72,
            "2010-2014": 60
          }
        },
        {
          "program_id": "TD_4KEY",
          "program_name": "4-Key Program (Near-Prime - Fair Credit)",
          "rates": {
            "min": 6.0,
            "max": 8.99
          },
          "credit_range": {
            "min_fico": 620,
            "max_fico": 679
          },
          "ltv": {
            "front_end": 100,
            "all_in": 105
          },
          "dsr": {
            "max": 40
          },
          "term": {
            "min": 24,
            "max": 84
          },
          "income": {
            "minimum": 24000
          }
        },
        {
          "program_id": "TD_5KEY",
          "program_name": "5-Key Program (Subprime)",
          "rates": {
            "min": 9.0,
            "max": 14.99
          },
          "credit_range": {
            "min_fico": 300,
            "max_fico": 619
          },
          "ltv": {
            "front_end": 90,
            "all_in": 100
          },
          "dsr": {
            "max": 40
          },
          "term": {
            "min": 24,
            "max": 72
          },
          "income": {
            "minimum": 18000
          }
        }
      ]
    },
    {
      "lender_name": "AUTOCAPITAL CANADA",
      "lender_code": "ACC",
      "contact": {
        "credit": "855-646-0534",
        "fax": "877-776-6213",
        "email": "accdocuments@autocapitalcanada.ca"
      },
      "general_notes": "Unlimited front-end advance & LTV on loans $13,500 and less (all tiers)",
      "programs": [
        {
          "program_id": "ACC_T1",
          "tier": 1,
          "program_name": "Tier 1 - Best Prime",
          "rates": {
            "from": 13.49
          },
          "ltv": {
            "front_end": 140,
            "all_in": 175
          },
          "dsr": {
            "max": 55
          },
          "term": {
            "max": 84
          },
          "admin_fee": 799,
          "dealer_reserve": {
            "up_to_15000": 300,
            "15000_plus": 500
          },
          "chargeback_days": 90,
          "term_caps_by_year_and_condition": {
            "2025": {
              "extra_clean": {
                "km_max": 40000,
                "term": 84
              },
              "clean": {
                "km_max": 65000,
                "term": 84
              },
              "average": {
                "km_max": 95000,
                "term": 84
              },
              "rough": {
                "km_max": 115000,
                "term": 84
              }
            },
            "2024": {
              "extra_clean": {
                "km_max": 65000,
                "term": 84
              },
              "clean": {
                "km_max": 95000,
                "term": 84
              },
              "average": {
                "km_max": 135000,
                "term": 84
              },
              "rough": {
                "km_max": 195000,
                "term": 78
              }
            },
            "2023": {
              "extra_clean": {
                "km_max": 80000,
                "term": 84
              },
              "clean": {
                "km_max": 115000,
                "term": 84
              },
              "average": {
                "km_max": 155000,
                "term": 84
              },
              "rough": {
                "km_max": 195000,
                "term": 72
              }
            },
            "2022": {
              "extra_clean": {
                "km_max": 90000,
                "term": 84
              },
              "clean": {
                "km_max": 120000,
                "term": 84
              },
              "average": {
                "km_max": 155000,
                "term": 78
              },
              "rough": {
                "km_max": 195000,
                "term": 66
              }
            },
            "2021": {
              "extra_clean": {
                "km_max": 100000,
                "term": 84
              },
              "clean": {
                "km_max": 135000,
                "term": 84
              },
              "average": {
                "km_max": 175000,
                "term": 78
              },
              "rough": {
                "km_max": 195000,
                "term": 66
              }
            },
            "2020": {
              "extra_clean": {
                "km_max": 105000,
                "term": 84
              },
              "clean": {
                "km_max": 140000,
                "term": 84
              },
              "average": {
                "km_max": 175000,
                "term": 72
              },
              "rough": {
                "km_max": 195000,
                "term": 66
              }
            },
            "2019": {
              "extra_clean": {
                "km_max": 115000,
                "term": 78
              },
              "clean": {
                "km_max": 145000,
                "term": 72
              },
              "average": {
                "km_max": 175000,
                "term": 66
              },
              "rough": {
                "km_max": 195000,
                "term": 54
              }
            },
            "2018": {
              "clean": {
                "km_max": 155000,
                "term": 66
              },
              "average": {
                "km_max": 175000,
                "term": 60
              },
              "rough": {
                "km_max": 195000,
                "term": 54
              }
            },
            "2017": {
              "clean": {
                "km_max": 155000,
                "term": 54
              },
              "average": {
                "km_max": 175000,
                "term": 54
              },
              "rough": {
                "km_max": 190000,
                "term": 48
              }
            },
            "2016": {
              "clean": {
                "km_max": 155000,
                "term": 42
              },
              "average": {
                "km_max": 170000,
                "term": 42
              },
              "rough": {
                "km_max": 190000,
                "term": 36
              }
            },
            "2015": {
              "clean": {
                "km_max": 155000,
                "term": 30
              },
              "average": {
                "km_max": 170000,
                "term": 30
              },
              "rough": {
                "km_max": 190000,
                "term": 24
              }
            }
          }
        },
        {
          "program_id": "ACC_T2",
          "tier": 2,
          "program_name": "Tier 2 - Strong Prime",
          "rates": {
            "from": 14.49
          },
          "ltv": {
            "front_end": 140,
            "all_in": 175
          },
          "dsr": {
            "max": 55
          },
          "term": {
            "max": 84
          },
          "admin_fee": 799,
          "dealer_reserve": {
            "up_to_15000": 300,
            "15000_plus": 500
          },
          "chargeback_days": 90
        },
        {
          "program_id": "ACC_T3",
          "tier": 3,
          "program_name": "Tier 3 - Prime",
          "rates": {
            "from": 15.99
          },
          "ltv": {
            "front_end": 140,
            "all_in": 165
          },
          "dsr": {
            "max": 50
          },
          "term": {
            "max": 84
          },
          "admin_fee": 799
        },
        {
          "program_id": "ACC_T4",
          "tier": 4,
          "program_name": "Tier 4 - Near-Prime",
          "rates": {
            "from": 17.99
          },
          "ltv": {
            "front_end": 135,
            "all_in": 165
          },
          "dsr": {
            "max": 47
          },
          "term": {
            "max": 84
          },
          "admin_fee": 799
        },
        {
          "program_id": "ACC_T5",
          "tier": 5,
          "program_name": "Tier 5 - Subprime",
          "rates": {
            "from": 21.49
          },
          "ltv": {
            "front_end": 135,
            "all_in": 150
          },
          "dsr": {
            "max": 43
          },
          "term": {
            "max": 78
          },
          "admin_fee": 799
        },
        {
          "program_id": "ACC_T6",
          "tier": 6,
          "program_name": "Tier 6 - High Risk",
          "rates": {
            "from": 23.49
          },
          "ltv": {
            "front_end": 130,
            "all_in": 150
          },
          "dsr": {
            "max": 43
          },
          "term": {
            "max": 72
          },
          "admin_fee": 799
        }
      ]
    },
    {
      "lender_name": "NATIONAL BANK OF CANADA",
      "lender_code": "NATIONAL_BANK",
      "contact": {
        "phone": "1-844-733-0434",
        "address": "800 St-Jacques, Suite 09881, Montreal (Quebec) H3C 1A3"
      },
      "programs": [
        {
          "program_id": "NATIONAL_BANK_STANDARD",
          "program_name": "Standard Fixed Rate Program",
          "quality_bonus": {
            "7500_to_12499": 500,
            "12500_to_19999": 625,
            "20000_to_24999": 1200,
            "25000_plus": 1200
          },
          "chargeback_days": 180,
          "no_cap_on_reserves": true,
          "term_caps_by_year": {
            "2023-2026": 96,
            "2020-2022": 84,
            "2019": 72,
            "2018": 60,
            "2017": 48,
            "2015-2016": 36
          }
        },
        {
          "program_id": "NATIONAL_BANK_EV",
          "program_name": "EV Special Program",
          "eligible_vehicles": [
            "HEV",
            "PHEV",
            "BEV",
            "FCEV"
          ],
          "rate": "Up to 6.74%",
          "quality_bonus": 1200,
          "min_model_year": 2015,
          "max_term": 96,
          "chargeback_days": 180
        }
      ]
    },
    {
      "lender_name": "CIBC AUTO FINANCE",
      "lender_code": "CIBC",
      "contact": {
        "credit": "1-855-598-1856",
        "customer_care": "1-800-465-2422",
        "funding_fax": "1-877-776-6197",
        "funding_email": "cibcemailfunding@autocapital.ca"
      },
      "programs": [
        {
          "program_id": "CIBC_2023_2026",
          "program_name": "2023-2026 Vehicle Program",
          "rate_range": {
            "min": 7.29,
            "max": 9.49
          },
          "quality_bonus": {
            "20000_plus": 1200,
            "under_20000": 600
          },
          "chargeback_days": 180,
          "term_caps": {
            "2023-2026": 96
          },
          "reserve_grid_by_rate_term_and_financed": "Multi-dimensional grid - see rate sheet"
        },
        {
          "program_id": "CIBC_2018_2022",
          "program_name": "2018-2022 Vehicle Program",
          "rate_range": {
            "min": 7.49,
            "max": 9.49
          },
          "quality_bonus": {
            "20000_plus": 1200,
            "under_20000": 600
          },
          "term_caps": {
            "2021-2022": 84,
            "2019-2020": 72,
            "2018": 60
          }
        },
        {
          "program_id": "CIBC_2018_UNDER60",
          "program_name": "2018+ (<60M) Vehicle Program",
          "rate_range": {
            "min": 7.99,
            "max": 8.99
          },
          "term_bands": "48-54 months"
        },
        {
          "program_id": "CIBC_2015_2017",
          "program_name": "2015-2017 Vehicle Program",
          "rate_range": {
            "min": 8.49,
            "max": 9.49
          },
          "term_bands": "36-48 months",
          "term_caps": {
            "2017": 48,
            "2015-2016": 36
          }
        },
        {
          "program_id": "CIBC_EV_GREEN",
          "program_name": "Green Vehicle Special (EV Program)",
          "rate": 6.52,
          "eligible_vehicles": [
            "HEV",
            "PHEV",
            "BEV",
            "FCEV"
          ],
          "quality_bonus": 1200,
          "min_financed": 20000,
          "min_model_year": 2023,
          "max_term": 96,
          "reserve_percent": 0.25,
          "donation": "CIBC donates $25 to Nature Conservancy of Canada per loan"
        },
        {
          "program_id": "CIBC_10YR_ANNIVERSARY",
          "program_name": "10-Year Anniversary Franchise Special",
          "rate_2024_2026": 6.49,
          "rate_2022_2026": 6.79,
          "rate_discount": 0.1,
          "quality_bonus": 1200,
          "min_financed": 20000,
          "new_demo_only": true,
          "term_caps": {
            "2023-2025": 96,
            "2022": 84
          }
        }
      ]
    },
    {
      "lender_name": "EDEN PARK INC",
      "lender_code": "EDEN_PARK",
      "contact": {
        "credit": "1-855-366-8667 ext. 761",
        "income": "1-855-366-8667 ext. 763",
        "funding": "1-855-366-8667 ext. 762",
        "customer_service": "1-855-366-8667 ext. 765",
        "fax": "faxes@edenparkcanada.com"
      },
      "programs": [
        {
          "program_id": "EDEN_6RIDE",
          "program_name": "6 Ride (Best Tier)",
          "rate_from": 11.99,
          "front_end_advance": 140,
          "max_term": 84,
          "max_payment_call": 950
        },
        {
          "program_id": "EDEN_5RIDE",
          "program_name": "5 Ride",
          "rate_from": 13.99,
          "front_end_advance": 140,
          "max_term": 84
        },
        {
          "program_id": "EDEN_4RIDE",
          "program_name": "4 Ride",
          "rate_from": 16.99,
          "front_end_advance": 140,
          "max_term": 84
        },
        {
          "program_id": "EDEN_3RIDE",
          "program_name": "3 Ride",
          "rate_from": 19.99,
          "front_end_advance": 135,
          "max_term": 84
        },
        {
          "program_id": "EDEN_2RIDE",
          "program_name": "2 Ride",
          "rate_from": 23.99,
          "front_end_advance": 130,
          "max_term": 84
        },
        {
          "program_id": "EDEN_RIDE_PLUS",
          "program_name": "EP Ride+ (Premium Program)",
          "rate_from": 11.99,
          "front_end_advance": 140,
          "max_term": 84
        },
        {
          "program_id": "EDEN_NO_HIT",
          "program_name": "EP No Hit",
          "rate_from": 19.99,
          "front_end_advance": 130,
          "max_term": 84
        }
      ],
      "dealer_reserve": {
        "up_to_10000": 250,
        "10001_to_15000": 300,
        "15001_to_20000": 450,
        "20001_to_25000": 500,
        "25001_to_45000": 600,
        "45001_plus": 750
      },
      "chargeback_days": 180,
      "special_programs": {
        "new_models": "2026-2025-2024 <5k km: 125% MSRP (84m); >5k km: 110% MSRP (84m)"
      }
    },
    {
      "lender_name": "RIFCO",
      "lender_code": "RIFCO",
      "contact": {
        "dealer_services": "1.855.478.2439",
        "income": "poi@rifco.net",
        "funding": "funding@rifco.net",
        "funding_checklist": "https://rifco.net/programs-and-checklist/"
      },
      "loan_fee": 395,
      "device_fee": 595,
      "min_income": 3000,
      "max_contract_apr": 32,
      "min_financing": 10000,
      "programs": [
        {
          "program_id": "RIFCO_AA_T1",
          "program_group": "All-Access Preferred",
          "tier": 1,
          "rate_from": 9.95,
          "front_end_ltv": 140,
          "all_in_ltv": 155,
          "dealer_reserve": 1200,
          "max_term": 84
        },
        {
          "program_id": "RIFCO_AA_T2",
          "tier": 2,
          "rate_from": 12.95,
          "dealer_reserve": 1100
        },
        {
          "program_id": "RIFCO_AA_T3",
          "tier": 3,
          "rate_from": 15.95,
          "dealer_reserve": 1000
        },
        {
          "program_id": "RIFCO_AA_T4",
          "tier": 4,
          "rate_from": 18.95,
          "front_end_ltv": 135,
          "dealer_reserve": 900
        },
        {
          "program_id": "RIFCO_AA_T5",
          "tier": 5,
          "rate_from": 22.95,
          "front_end_ltv": 130,
          "dealer_reserve": 800
        },
        {
          "program_id": "RIFCO_AA_T6",
          "tier": 6,
          "rate_from": 25.95,
          "dealer_reserve": 700
        },
        {
          "program_id": "RIFCO_AA_THIN",
          "program_group": "All-Access Preferred",
          "tier": "THIN",
          "description": "Limited or no credit history",
          "rate_from": 28.95,
          "front_end_ltv": 125,
          "all_in_ltv": 155,
          "dealer_reserve": "Base 2% up to max"
        },
        {
          "program_id": "RIFCO_STD_PREFERRED",
          "program_group": "Standard Program",
          "variant": "Preferred",
          "rate_from": 29.95,
          "front_end_ltv": 130,
          "all_in_ltv": 155,
          "max_payment_call": 3000,
          "dealer_reserve": 250
        },
        {
          "program_id": "RIFCO_STD_STANDARD",
          "variant": "Standard",
          "rate_from": 29.95,
          "dealer_reserve": 300
        },
        {
          "program_id": "RIFCO_STD_DRIVE_PLAN",
          "variant": "Drive Plan",
          "rate_from": 29.95,
          "required_device": "Starter Interrupter + GPS (PASSTIME)",
          "gps_provider_login": "https://oasis.passtimeusa.com/login"
        }
      ]
    }
  ]
}
</file>

<file path="src/api/ghl-client.ts">
import axios, { AxiosInstance, AxiosError } from 'axios';
import config from '../config/config';
import logger from '../utils/logger';

export class GHLClient {
  private client: AxiosInstance;

  constructor() {
    this.client = axios.create({
      baseURL: config.GHL_BASE_URL,
      timeout: 30000,
      headers: {
        Authorization: `Bearer ${config.GHL_API_KEY}`,
        'Content-Type': 'application/json',
        Version: '2021-07-28',
      },
    });

    this.client.interceptors.response.use(
      (res) => res,
      (err: AxiosError) => {
        const status = err.response?.status;
        if (status === 429) {
          logger.warn('Rate limited by GHL', { status });
        }
        logger.error('GHL request failed', { status, data: err.response?.data });
        return Promise.reject(err);
      }
    );
  }

  async getContact(contactId: string) {
    const res = await this.client.get(`/contacts/${contactId}`);
    return res.data;
  }
}

export const ghlClient = new GHLClient();
export default ghlClient;
</file>

<file path="src/api/middleware.ts">
import { Request, Response, NextFunction } from 'express';
import logger from '../utils/logger';

export function requestLogger(req: Request, res: Response, next: NextFunction) {
  const start = Date.now();
  res.on('finish', () => {
    const duration = Date.now() - start;
    logger.info('req', { method: req.method, path: req.path, status: res.statusCode, duration });
  });
  next();
}

export function errorHandler(err: any, req: Request, res: Response, _next: NextFunction) {
  logger.error('error', { message: err?.message, stack: err?.stack, path: req.path });
  const status = err?.status || err?.statusCode || 500;
  res.status(status).json({ success: false, error: err?.message || 'Internal Server Error' });
}

export function healthCheck(_req: Request, res: Response) {
  res.json({
    success: true,
    status: 'ok',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'development'
  });
}
</file>

<file path="src/config/config.ts">
import dotenv from 'dotenv';

dotenv.config();

export const config = {
  PORT: parseInt(process.env.PORT || '10000', 10),
  NODE_ENV: process.env.NODE_ENV || 'development',

  GHL_API_KEY: process.env.GHL_API_KEY || '',
  GHL_BASE_URL: process.env.GHL_BASE_URL || 'https://services.leadconnectorhq.com/v1',
  GHL_LOCATION_ID: process.env.GHL_LOCATION_ID || '',
  GHL_INBOUND_WEBHOOK_URL: process.env.GHL_INBOUND_WEBHOOK_URL || '',
  GHL_WEBHOOK_SECRET: process.env.GHL_WEBHOOK_SECRET || '',

  VINAUDIT_API_KEY: process.env.VINAUDIT_API_KEY || '',

  SUPABASE_URL: process.env.SUPABASE_URL || '',
  SUPABASE_ANON_KEY: process.env.SUPABASE_ANON_KEY || '',

  RATE_LIMIT_WINDOW_MS: 60000,
  RATE_LIMIT_MAX_REQUESTS: 120,
} as const;

export type AppConfig = typeof config;
export default config;
</file>

<file path="src/modules/aftermarket-products.ts">
/**
 * MODULE 5: AFTERMARKET PRODUCTS PRICING
 * Fixed pricing (NOT percentages) for warranties, gap, tire & rim, appearance
 */

import { Product, ProductBundle } from '../types/types';

export const PRODUCTS = {
  WARRANTY_ECONOMY: {
    name: 'Extended Warranty - Economy',
    category: 'warranty' as const,
    retailPrice: 1500,
    cost: 750,
    margin: 750,
  },
  WARRANTY_MID: {
    name: 'Extended Warranty - Mid-Range',
    category: 'warranty' as const,
    retailPrice: 2150,
    cost: 1075,
    margin: 1075,
  },
  WARRANTY_PREMIUM: {
    name: 'Extended Warranty - Premium',
    category: 'warranty' as const,
    retailPrice: 3000,
    cost: 1500,
    margin: 1500,
  },
  GAP: {
    name: 'Gap Insurance',
    category: 'gap' as const,
    retailPrice: 649,
    cost: 200,
    margin: 449,
  },
  TIRE_BASIC: {
    name: 'Tire & Rim - Basic',
    category: 'tire' as const,
    retailPrice: 449,
    cost: 200,
    margin: 249,
  },
  TIRE_PREMIUM: {
    name: 'Tire & Rim - Premium',
    category: 'tire' as const,
    retailPrice: 649,
    cost: 325,
    margin: 324,
  },
  TIRE_ULTIMATE: {
    name: 'Tire & Rim - Ultimate',
    category: 'tire' as const,
    retailPrice: 1049,
    cost: 500,
    margin: 549,
  },
  PAINT: {
    name: 'Paint Protection',
    category: 'appearance' as const,
    retailPrice: 349,
    cost: 175,
    margin: 174,
  },
  FABRIC: {
    name: 'Fabric Protection',
    category: 'appearance' as const,
    retailPrice: 249,
    cost: 125,
    margin: 124,
  },
  PAINT_FABRIC: {
    name: 'Paint & Fabric Protection',
    category: 'appearance' as const,
    retailPrice: 499,
    cost: 250,
    margin: 249,
  },
};

export function recommendBundles(
  cbbValue: number,
  lender: string
): ProductBundle[] {
  const bundles: ProductBundle[] = [];

  let warrantyProduct = PRODUCTS.WARRANTY_ECONOMY;
  if (cbbValue >= 20000 && cbbValue < 35000) {
    warrantyProduct = PRODUCTS.WARRANTY_MID;
  } else if (cbbValue >= 35000) {
    warrantyProduct = PRODUCTS.WARRANTY_PREMIUM;
  }

  bundles.push({
    products: [warrantyProduct],
    totalRetail: warrantyProduct.retailPrice,
    totalCost: warrantyProduct.cost,
    totalMargin: warrantyProduct.margin,
  });

  bundles.push({
    products: [warrantyProduct, PRODUCTS.GAP, PRODUCTS.TIRE_BASIC],
    totalRetail:
      warrantyProduct.retailPrice + PRODUCTS.GAP.retailPrice + PRODUCTS.TIRE_BASIC.retailPrice,
    totalCost:
      warrantyProduct.cost + PRODUCTS.GAP.cost + PRODUCTS.TIRE_BASIC.cost,
    totalMargin:
      warrantyProduct.margin + PRODUCTS.GAP.margin + PRODUCTS.TIRE_BASIC.margin,
  });

  bundles.push({
    products: [warrantyProduct, PRODUCTS.GAP, PRODUCTS.TIRE_PREMIUM, PRODUCTS.PAINT_FABRIC],
    totalRetail:
      warrantyProduct.retailPrice +
      PRODUCTS.GAP.retailPrice +
      PRODUCTS.TIRE_PREMIUM.retailPrice +
      PRODUCTS.PAINT_FABRIC.retailPrice,
    totalCost:
      warrantyProduct.cost + PRODUCTS.GAP.cost + PRODUCTS.TIRE_PREMIUM.cost + PRODUCTS.PAINT_FABRIC.cost,
    totalMargin:
      warrantyProduct.margin + PRODUCTS.GAP.margin + PRODUCTS.TIRE_PREMIUM.margin + PRODUCTS.PAINT_FABRIC.margin,
  });

  return bundles;
}

export function validateProductFit(
  productBundle: ProductBundle,
  cbbValue: number,
  lender: string
): { fits: boolean; maxAllowed: number; percentOfCBB: number } {
  const limit = lender === 'Santander' ? 0.3 : 0.4;
  const maxAllowed = cbbValue * limit;
  const percentOfCBB = (productBundle.totalRetail / cbbValue) * 100;

  return {
    fits: productBundle.totalRetail <= maxAllowed,
    maxAllowed,
    percentOfCBB,
  };
}
</file>

<file path="src/modules/compliance-validator.ts">
/**
 * MODULE 4: DSR & LTV COMPLIANCE VALIDATOR
 * Validates Debt Service Ratio and Loan-to-Value against lender limits
 */

import { ComplianceResult, LenderType } from '../types/types';
import { getLenderProgram } from './lender-programs';

export function validateCompliance(
  monthlyPayment: number,
  monthlyIncome: number,
  financeAmount: number,
  cbbWholesaleValue: number,
  lender: LenderType,
  tier: string
): ComplianceResult {
  const program = getLenderProgram(lender, tier);
  if (!program) {
    throw new Error(`Invalid lender/tier: ${lender}/${tier}`);
  }

  const dsr = monthlyIncome > 0 ? (monthlyPayment / monthlyIncome) * 100 : 0;
  const dsrPass = dsr <= program.maxDsr;

  const ltv = cbbWholesaleValue > 0 ? (financeAmount / cbbWholesaleValue) * 100 : 0;
  const ltvPass = ltv <= program.ltv;

  const warnings: string[] = [];

  if (dsr > program.maxDsr * 0.9) {
    warnings.push(`HIGH DSR: ${dsr.toFixed(1)}% (max: ${program.maxDsr}%)`);
  }
  if (ltv > 130) {
    warnings.push(`HIGH LTV: ${ltv.toFixed(1)}% - minimal equity cushion`);
  }
  if (dsr > program.maxDsr && ltv > program.ltv) {
    warnings.push('MARGINAL DEAL: Both DSR and LTV are high');
  }

  return {
    dsr: Math.round(dsr * 100) / 100,
    dsrPass,
    ltv: Math.round(ltv * 100) / 100,
    ltvPass,
    overall: dsrPass && ltvPass,
    warnings,
  };
}

export function checkIncomeRequirement(
  monthlyIncome: number,
  lender: LenderType,
  tier: string
): boolean {
  const program = getLenderProgram(lender, tier);
  if (!program) return false;
  return monthlyIncome >= program.minIncome;
}
</file>

<file path="src/modules/deal-maximizer.ts">
/**
 * MODULE 6: DEAL MAXIMIZER ALGORITHM (CORE ENGINE)
 * Scans inventory, applies filters, calculates compliance, ranks by gross profit
 */

import { Deal, Vehicle, FindDealsRequest, LenderType, ProductBundle } from '../types/types';
import { calculateMonthlyPayment } from './payment-calculator';
import { calculateTradeInEquity } from './trade-in-equity';
import { validateCompliance } from './compliance-validator';
import { recommendBundles, validateProductFit } from './aftermarket-products';
import { getLenderProgram, getBaseReserve } from './lender-programs';

function generateDealId(): string {
  return `DEAL-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
}

export function findOptimalDeals(
  request: FindDealsRequest,
  inventory: Vehicle[]
): Deal[] {
  const deals: Deal[] = [];
  const program = getLenderProgram(request.lender, request.tier);

  if (!program) {
    throw new Error(`Invalid lender/tier: ${request.lender}/${request.tier}`);
  }

  let filtered = inventory.filter(v => v.inStock);
  if (request.inventoryFilter?.make) {
    filtered = filtered.filter(v => v.make.toLowerCase().includes(request.inventoryFilter!.make!.toLowerCase()));
  }
  if (request.inventoryFilter?.maxMileage) {
    filtered = filtered.filter(v => v.mileage <= request.inventoryFilter!.maxMileage!);
  }

  for (const vehicle of filtered) {
    const vehicleDeals = processVehicle(
      vehicle,
      request,
      program
    );
    deals.push(...vehicleDeals);
  }

  const compliantDeals = deals.filter(d => d.compliance.overall);
  compliantDeals.sort((a, b) => b.grossProfit.total - a.grossProfit.total);

  return compliantDeals.slice(0, 10).map((deal, idx) => ({
    ...deal,
    rank: idx + 1,
  }));
}

function processVehicle(
  vehicle: Vehicle,
  request: FindDealsRequest,
  program: any
): Deal[] {
  const deals: Deal[] = [];

  const tradeEquity = request.tradeInValue
    ? calculateTradeInEquity(request.tradeInValue, request.tradeInBalance || 0, request.lender, request.tier)
    : { type: 'zero' as const, equityAmount: 0, canRollover: false, rolledAmount: 0 };

  let baseFinance = vehicle.suggestedPrice - request.downPayment - (tradeEquity.type === 'positive' ? tradeEquity.equityAmount : 0);
  if (tradeEquity.canRollover) {
    baseFinance += tradeEquity.rolledAmount;
  }
  baseFinance += program.fee;

  const bundles = recommendBundles(vehicle.cbbWholesale, request.lender);

  for (const bundle of bundles) {
    const productFit = validateProductFit(bundle, vehicle.cbbWholesale, request.lender);
    if (!productFit.fits) continue;

    const financeAmount = baseFinance + bundle.totalRetail;

    const paymentCalc = calculateMonthlyPayment(financeAmount, program.rate, request.term);

    const compliance = validateCompliance(
      paymentCalc.monthlyPayment,
      request.monthlyIncome,
      financeAmount,
      vehicle.cbbWholesale,
      request.lender,
      request.tier
    );

    const vehicleGross = vehicle.suggestedPrice - vehicle.yourCost;
    const lenderReserve = getBaseReserve(program);
    const rateUpsell = (financeAmount * (program.rateUpsell || 0)) / 100;

    const deal: Deal = {
      id: generateDealId(),
      rank: 0,
      vehicle,
      lender: request.lender,
      tier: request.tier,
      salePrice: vehicle.suggestedPrice,
      downPayment: request.downPayment,
      financeAmount,
      monthlyPayment: paymentCalc.monthlyPayment,
      term: request.term,
      compliance,
      productBundle: bundle,
      grossProfit: {
        vehicleGross,
        lenderReserve,
        rateUpsell,
        productMargin: bundle.totalMargin,
        total: vehicleGross + lenderReserve + rateUpsell + bundle.totalMargin,
      },
      dealertrackCopy: generateDealertrackCopy(vehicle, paymentCalc.monthlyPayment, financeAmount, program),
    };

    deals.push(deal);
  }

  return deals;
}

function generateDealertrackCopy(vehicle: Vehicle, payment: number, finance: number, program: any): string {
  return `Vehicle: ${vehicle.year} ${vehicle.make} ${vehicle.model}
Stock: ${vehicle.id}
VIN: ${vehicle.vin}
Price: $${vehicle.suggestedPrice.toLocaleString()}
Finance: $${finance.toLocaleString()}
Payment: $${payment}/month
Rate: ${program.rate}%
Lender: ${program.lender}`;
}
</file>

<file path="src/modules/ghl-integration.ts">
/**
 * MODULE 10: GOHIGHLEVEL INTEGRATION
 * Saves deals to GoHighLevel CRM system
 */

import axios from 'axios';
import { Deal, GHLResponse } from '../types/types';

export async function saveDealToGHL(
  deal: Deal,
  customerId: string,
  accessToken: string
): Promise<GHLResponse> {
  try {
    const noteContent = formatDealNote(deal);

    const { data } = await axios.post(
      `https://rest.gohighlevel.com/v1/contacts/${encodeURIComponent(customerId)}/notes`,
      {
        body: noteContent,
        tags: ['deal', deal.lender, deal.tier],
      },
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
        },
        timeout: 15000,
      }
    );

    return {
      success: true,
      noteId: data.id,
      dealLink: generateDealLink(deal, customerId),
    };
  } catch (error) {
    return {
      success: false,
      error: `Failed to save to GHL: ${(error as Error).message}`,
    };
  }
}

export function generateDealLink(deal: Deal, customerId: string): string {
  return `https://your-domain.com/desk?contact_id=${customerId}&deal_id=${deal.id}&vehicle_id=${deal.vehicle.id}&lender=${deal.lender}&tier=${deal.tier}`;
}

function formatDealNote(deal: Deal): string {
  return `
VEHICLE DEAL
${deal.vehicle.year} ${deal.vehicle.make} ${deal.vehicle.model}
Stock: ${deal.vehicle.id} | VIN: ${deal.vehicle.vin}

DEAL STRUCTURE
Sale Price: $${deal.salePrice.toLocaleString()}
Down Payment: $${deal.downPayment.toLocaleString()}
Amount to Finance: $${deal.financeAmount.toLocaleString()}
Monthly Payment: $${deal.monthlyPayment}/month

LENDER
${deal.lender} ${deal.tier}

COMPLIANCE
DSR: ${deal.compliance.dsr.toFixed(2)}% ${deal.compliance.dsrPass ? '✓' : '✗'}
LTV: ${deal.compliance.ltv.toFixed(2)}% ${deal.compliance.ltvPass ? '✓' : '✗'}
Status: ${deal.compliance.overall ? 'COMPLIANT' : 'NON-COMPLIANT'}

GROSS PROFIT
Vehicle Gross: $${deal.grossProfit.vehicleGross.toLocaleString()}
Lender Reserve: $${deal.grossProfit.lenderReserve.toLocaleString()}
Rate Upsell: $${deal.grossProfit.rateUpsell.toLocaleString()}
Product Margin: $${deal.grossProfit.productMargin.toLocaleString()}
TOTAL: $${deal.grossProfit.total.toLocaleString()}
`;
}
</file>

<file path="src/modules/lender-programs.ts">
/**
 * MODULE 2: LENDER PROGRAMS DATABASE
 * Hardcoded lender specifications from official 2025 rate sheets
 * TD, Santander, and Scotia Dealer Advantage
 */

import { LenderProgram, LenderType } from '../types/types';

const LENDER_PROGRAMS: Record<string, Record<string, LenderProgram>> = {
  TD: {
    '2-Key': {
      lender: 'TD',
      tier: '2-Key',
      rate: 11.99,
      ltv: 140,
      maxDsr: 50,
      minIncome: 1800,
      reserve: 300,
      fee: 799,
      negativeEquityLimit: 5000,
    },
    '3-Key': {
      lender: 'TD',
      tier: '3-Key',
      rate: 13.49,
      ltv: 140,
      maxDsr: 50,
      minIncome: 1800,
      reserve: 550,
      fee: 799,
      negativeEquityLimit: 5000,
    },
    '4-Key': {
      lender: 'TD',
      tier: '4-Key',
      rate: 15.99,
      ltv: 140,
      maxDsr: 50,
      minIncome: 1800,
      reserve: 600,
      fee: 799,
      negativeEquityLimit: 5000,
    },
    '5-Key': {
      lender: 'TD',
      tier: '5-Key',
      rate: 17.99,
      ltv: 140,
      maxDsr: 50,
      minIncome: 1800,
      reserve: 750,
      fee: 799,
      negativeEquityLimit: 5000,
    },
  },
  Santander: {
    'Tier8': {
      lender: 'Santander',
      tier: 'Tier8',
      rate: 11.49,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 600,
      fee: 0,
      negativeEquityLimit: 5000,
    },
    'Tier7': {
      lender: 'Santander',
      tier: 'Tier7',
      rate: 13.49,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 600,
      fee: 0,
      negativeEquityLimit: 5000,
    },
    'Tier6': {
      lender: 'Santander',
      tier: 'Tier6',
      rate: 16.49,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 550,
      fee: 0,
      negativeEquityLimit: 4000,
    },
    'Tier5': {
      lender: 'Santander',
      tier: 'Tier5',
      rate: 21.99,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 550,
      fee: 0,
      negativeEquityLimit: 3500,
    },
    'Tier4': {
      lender: 'Santander',
      tier: 'Tier4',
      rate: 24.49,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 550,
      fee: 0,
      negativeEquityLimit: 3500,
    },
    'Tier3': {
      lender: 'Santander',
      tier: 'Tier3',
      rate: 26.24,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 525,
      fee: 0,
      negativeEquityLimit: 3000,
    },
    'Tier2': {
      lender: 'Santander',
      tier: 'Tier2',
      rate: 29.99,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 750,
      fee: 0,
      negativeEquityLimit: 3000,
    },
    'Tier1': {
      lender: 'Santander',
      tier: 'Tier1',
      rate: 31.9,
      ltv: 165,
      maxDsr: 30,
      minIncome: 2500,
      reserve: 500,
      fee: 0,
      negativeEquityLimit: 3000,
    },
  },
  SDA: {
    'Star7': {
      lender: 'SDA',
      tier: 'Star7',
      rate: 11.99,
      ltv: 180,
      maxDsr: 65,
      minIncome: 1750,
      reserve: 600,
      fee: 399,
      negativeEquityLimit: 5000,
      rateUpsell: 2,
    },
    'Star6': {
      lender: 'SDA',
      tier: 'Star6',
      rate: 13.49,
      ltv: 180,
      maxDsr: 60,
      minIncome: 1750,
      reserve: 600,
      fee: 699,
      negativeEquityLimit: 5000,
      rateUpsell: 2,
    },
    'Star5': {
      lender: 'SDA',
      tier: 'Star5',
      rate: 14.49,
      ltv: 160,
      maxDsr: 55,
      minIncome: 1750,
      reserve: 500,
      fee: 699,
      negativeEquityLimit: 5000,
      rateUpsell: 2,
    },
    'Star4': {
      lender: 'SDA',
      tier: 'Star4',
      rate: 18.49,
      ltv: 150,
      maxDsr: 55,
      minIncome: 1750,
      reserve: 300,
      fee: 699,
      negativeEquityLimit: 4000,
      rateUpsell: 2,
    },
    'Star3': {
      lender: 'SDA',
      tier: 'Star3',
      rate: 21.99,
      ltv: 140,
      maxDsr: 45,
      minIncome: 1750,
      reserve: 400,
      fee: 699,
      negativeEquityLimit: 4000,
      rateUpsell: 2,
    },
    'Star2': {
      lender: 'SDA',
      tier: 'Star2',
      rate: 27.99,
      ltv: 140,
      maxDsr: 45,
      minIncome: 1750,
      reserve: 300,
      fee: 799,
      negativeEquityLimit: 3000,
      rateUpsell: 2,
    },
    'Star1': {
      lender: 'SDA',
      tier: 'Star1',
      rate: 29.99,
      ltv: 140,
      maxDsr: 45,
      minIncome: 1750,
      reserve: 100,
      fee: 799,
      negativeEquityLimit: 3000,
      rateUpsell: 2,
    },
    'StartRight': {
      lender: 'SDA',
      tier: 'StartRight',
      rate: 15.49,
      ltv: 140,
      maxDsr: 65,
      minIncome: 1750,
      reserve: 300,
      fee: 599,
      negativeEquityLimit: 5000,
      rateUpsell: 2,
    },
  },
};

export function getLenderProgram(lender: LenderType, tier: string): LenderProgram | null {
  return LENDER_PROGRAMS[lender]?.[tier] || null;
}

export function getLenderTiers(lender: LenderType): string[] {
  return Object.keys(LENDER_PROGRAMS[lender] || {});
}

export function getAllLenderPrograms(): Record<string, Record<string, LenderProgram>> {
  return LENDER_PROGRAMS;
}

export function getBaseReserve(program: LenderProgram): number {
  return program.reserve;
}
</file>

<file path="src/modules/supabase.ts">
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import { Vehicle } from '../types/types';

let cached: SupabaseClient | null | undefined;

export function getSupabase(): SupabaseClient | null {
  if (cached !== undefined) return cached as SupabaseClient | null;
  const url = process.env.SUPABASE_URL;
  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;
  if (!url || !key) { cached = null; return null; }
  try {
    cached = createClient(url, key, { auth: { persistSession: false } });
    return cached;
  } catch (_e) {
    cached = null;
    return null;
  }
}

function toRow(v: Vehicle) {
  return {
    id: v.id,
    vin: v.vin,
    year: v.year,
    make: v.make,
    model: v.model,
    trim: v.trim ?? null,
    mileage: v.mileage,
    color: v.color ?? null,
    engine: v.engine,
    transmission: v.transmission,
    cbb_wholesale: v.cbbWholesale,
    cbb_retail: v.cbbRetail,
    your_cost: v.yourCost,
    suggested_price: v.suggestedPrice,
    in_stock: v.inStock,
    image_url: v.imageUrl ?? null,
    black_book_value: v.blackBookValue ?? null,
  } as const;
}

function fromRow(r: any): Vehicle {
  return {
    id: String(r.id),
    vin: String(r.vin || ''),
    year: Number(r.year || 0),
    make: String(r.make || 'Unknown'),
    model: String(r.model || 'Unknown'),
    trim: r.trim || undefined,
    mileage: Number(r.mileage || 0),
    color: r.color || undefined,
    engine: String(r.engine || 'Unknown'),
    transmission: String(r.transmission || 'Unknown'),
    cbbWholesale: Number(r.cbb_wholesale || 0),
    cbbRetail: Number(r.cbb_retail || 0),
    yourCost: Number(r.your_cost || 0),
    suggestedPrice: Number(r.suggested_price || 0),
    inStock: Boolean(r.in_stock !== false),
    imageUrl: r.image_url || undefined,
    blackBookValue: r.black_book_value != null ? Number(r.black_book_value) : undefined,
  };
}

export async function saveInventoryToSupabase(vehicles: Vehicle[]): Promise<void> {
  const sb = getSupabase();
  if (!sb) return;
  if (!vehicles || vehicles.length === 0) return;
  const rows = vehicles.map(toRow);
  // upsert by id
  const { error } = await sb.from('vehicles').upsert(rows, { onConflict: 'id' });
  if (error) throw new Error('Supabase upsert failed: ' + error.message);
}

export async function fetchInventoryFromSupabase(): Promise<Vehicle[]> {
  const sb = getSupabase();
  if (!sb) return [];
  const { data, error } = await sb.from('vehicles').select('*').limit(1000);
  if (error) throw new Error('Supabase select failed: ' + error.message);
  return (data || []).map(fromRow);
}
</file>

<file path="src/modules/tax-calculator.ts">
/**
 * MODULE 7: CANADIAN PROVINCIAL TAX CALCULATOR
 * Calculates sales tax by province with trade-in credit deduction
 */

import { TaxResult, Province } from '../types/types';

const TAX_RATES: Record<Province, number> = {
  AB: 0.05,
  BC: 0.12,
  SK: 0.11,
  MB: 0.12,
  ON: 0.13,
  QC: 0.14975,
  NS: 0.15,
  NB: 0.15,
  PE: 0.15,
  NL: 0.15,
};

export function calculateTaxSavings(
  salePrice: number,
  tradeInCredit: number,
  province: Province
): TaxResult {
  const taxRate = TAX_RATES[province];
  if (!taxRate) throw new Error(`Unknown province: ${province}`);

  const taxableBase = salePrice - tradeInCredit;
  const totalTax = taxableBase * taxRate;
  const taxWithoutTrade = salePrice * taxRate;
  const taxSavings = taxWithoutTrade - totalTax;

  return {
    province,
    taxRate,
    salePrice,
    taxableBase,
    totalTax: Math.round(totalTax * 100) / 100,
    taxSavingsWithTrade: Math.round(taxSavings * 100) / 100,
  };
}
</file>

<file path="src/modules/trade-in-equity.ts">
/**
 * MODULE 3: TRADE-IN EQUITY CALCULATOR
 * Calculates trade-in equity and rollover limits by lender
 */

import { TradeInEquityResult, LenderType } from '../types/types';
import { getLenderProgram } from './lender-programs';

export function calculateTradeInEquity(
  tradeValue: number,
  outstandingBalance: number,
  lender: LenderType,
  tier: string
): TradeInEquityResult {
  const equity = tradeValue - outstandingBalance;
  const program = getLenderProgram(lender, tier);

  if (!program) {
    throw new Error(`Invalid lender/tier: ${lender}/${tier}`);
  }

  if (equity >= 0) {
    return {
      type: 'positive',
      equityAmount: equity,
      canRollover: false,
      maxRolloverLimit: 0,
      rolledAmount: 0,
      note: `$${equity.toFixed(2)} positive equity available as credit`,
    };
  }

  const negativeAmount = Math.abs(equity);
  const canRoll = negativeAmount <= program.negativeEquityLimit;

  return {
    type: 'negative',
    equityAmount: negativeAmount,
    canRollover: canRoll,
    maxRolloverLimit: program.negativeEquityLimit,
    rolledAmount: canRoll ? negativeAmount : 0,
    note: canRoll
      ? `$${negativeAmount.toFixed(2)} negative equity can be rolled (limit: $${program.negativeEquityLimit})` 
      : `$${negativeAmount.toFixed(2)} negative equity EXCEEDS ${lender} limit of $${program.negativeEquityLimit}`,
  };
}

export function getTradeInTaxImpact(
  salePrice: number,
  tradeCredit: number,
  rolledNegativeEquity: number
): { taxableBase: number; taxSavings: number } {
  const taxableBase = salePrice - tradeCredit;
  const taxSavings = tradeCredit;

  return {
    taxableBase,
    taxSavings,
  };
}
</file>

<file path="src/modules/vin-decoder.ts">
/**
 * MODULE 8: VIN DECODER
 * Extracts vehicle information from VIN number
 */

import axios from 'axios';
import { VINDecodingResult } from '../types/types';

export function decodeVIN(vin: string): VINDecodingResult {
  if (!/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
    throw new Error('Invalid VIN format');
  }

  const yearChar = vin.charAt(9);
  const year = decodeModelYear(yearChar);
  const manufacturer = decodeManufacturer(vin.substring(0, 3));
  const modelInfo = decodeModel(vin.substring(3, 8));

  return {
    year,
    make: manufacturer,
    model: modelInfo.model,
    body: modelInfo.body,
    engine: modelInfo.engine,
    transmission: 'Unknown',
  };
}

const VINAUDIT_API_KEY = process.env.VINAUDIT_API_KEY;
const VINAUDIT_BASE_URL = 'https://api.vinaudit.ca/v2';

/**
 * Attempt to decode VIN via VinAudit Canada API.
 * Falls back to static decoder if API key is missing or API fails.
 */
export async function decodeVINWithVinAudit(vin: string): Promise<VINDecodingResult> {
  if (!/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
    throw new Error('Invalid VIN format: Must be 17 characters (excluding I, O, Q)');
  }

  if (!VINAUDIT_API_KEY) {
    return decodeVIN(vin);
  }

  try {
    const response = await axios.get(`${VINAUDIT_BASE_URL}/specifications`, {
      params: { key: VINAUDIT_API_KEY, vin, format: 'json' },
      timeout: 5000,
    });
    const data = response.data;
    const specs = data?.attributes || {};

    const year = parseInt(specs.year) || decodeModelYear(vin.charAt(9));
    return {
      year,
      make: specs.make || 'Unknown',
      model: specs.model || 'Unknown',
      body: specs.body_style || 'Unknown',
      engine: specs.engine || 'Unknown',
      transmission: specs.transmission || 'Unknown',
    };
  } catch (_e) {
    return decodeVIN(vin);
  }
}

function decodeModelYear(char: string): number {
  const yearMap: Record<string, number> = {
    Y: 2000, Z: 2001, A: 2010, B: 2011, C: 2012, D: 2013, E: 2014,
    F: 2015, G: 2016, H: 2017, J: 2018, K: 2019, L: 2020, M: 2021,
    N: 2022, P: 2023, R: 2024, S: 2025, T: 2026, V: 2027, W: 2028,
  };
  return yearMap[char] || new Date().getFullYear();
}

function decodeManufacturer(code: string): string {
  const manufacturers: Record<string, string> = {
    JHM: 'Honda', JT2: 'Toyota', JT3: 'Toyota', JT4: 'Toyota',
    JF1: 'Subaru', JF2: 'Subaru', KMH: 'Hyundai', KNA: 'Kia',
    '1G1': 'Chevrolet', '1G3': 'Oldsmobile', '1GT': 'GMC',
    '2G1': 'Pontiac', '2G6': 'Cadillac', '2HG': 'Honda',
    '2T1': 'Toyota', '2T3': 'Toyota', '3G1': 'Chevrolet',
    '3G2': 'Pontiac', '3G5': 'Chevrolet', '5TNM': 'Toyota',
  };
  return manufacturers[code] || 'Unknown';
}

function decodeModel(code: string): {
  model: string;
  body: string;
  engine: string;
} {
  return {
    model: 'Model',
    body: 'Sedan',
    engine: '2.0L',
  };
}

/**
 * Get market valuation from VinAudit Canada.
 */
export async function getVehicleValuation(
  vin: string,
  mileage?: number
): Promise<{ wholesale: number; retail: number }> {
  if (!VINAUDIT_API_KEY) {
    throw new Error('VINAUDIT_API_KEY required for valuations');
  }

  // Official doc shows marketvalue endpoint on marketvalue.vinaudit.com
  const response = await axios.get('https://marketvalue.vinaudit.com/getmarketvalue.php', {
    params: {
      key: VINAUDIT_API_KEY,
      vin,
      mileage,
      period: 90,
      country: 'canada',
      format: 'json',
    },
    timeout: 5000,
  });

  const data = response.data || {};
  const wholesale = data.wholesale_mean ?? data.prices?.below ?? data.below ?? 0;
  const retail = data.retail_mean ?? data.market_value?.mean ?? data.prices?.average ?? data.mean ?? 0;

  return { wholesale, retail };
}
</file>

<file path="src/tests/all.test.ts">
/**
 * COMPREHENSIVE UNIT TESTS
 */

import { calculateMonthlyPayment } from '../modules/payment-calculator';
import { getLenderProgram } from '../modules/lender-programs';
import { calculateTradeInEquity } from '../modules/trade-in-equity';
import { validateCompliance } from '../modules/compliance-validator';
import { recommendBundles } from '../modules/aftermarket-products';
import { calculateTaxSavings } from '../modules/tax-calculator';

describe('Finance-in-a-Box Test Suite', () => {
  describe('Payment Calculator', () => {
    test('should calculate payment correctly: $20,199 @ 21.99% / 84m', () => {
      const result = calculateMonthlyPayment(20199, 21.99, 84);
      expect(result.monthlyPayment).toBe(475);
    });

    test('should calculate payment correctly: $10,000 @ 11.99% / 60m', () => {
      const result = calculateMonthlyPayment(10000, 11.99, 60);
      expect(result.monthlyPayment).toBe(220);
    });

    test('should validate principal range', () => {
      expect(() => calculateMonthlyPayment(5000, 15, 60)).toThrow();
      expect(() => calculateMonthlyPayment(150000, 15, 60)).toThrow();
    });

    test('should generate amortization schedule', () => {
      const result = calculateMonthlyPayment(10000, 15, 24);
      expect(result.amortizationSchedule.length).toBe(24);
      expect(result.amortizationSchedule[result.amortizationSchedule.length-1].balance).toBe(0);
    });
  });

  describe('Lender Programs', () => {
    test('should retrieve TD 2-Key program', () => {
      const program = getLenderProgram('TD', '2-Key');
      expect(program?.rate).toBe(11.99);
      expect(program?.ltv).toBe(140);
    });

    test('should retrieve Santander Tier 8', () => {
      const program = getLenderProgram('Santander', 'Tier8');
      expect(program?.rate).toBe(11.49);
      expect(program?.ltv).toBe(165);
    });

    test('should retrieve SDA Star 3', () => {
      const program = getLenderProgram('SDA', 'Star3');
      expect(program?.rate).toBe(21.99);
      expect(program?.ltv).toBe(140);
    });
  });

  describe('Trade-In Equity', () => {
    test('should calculate positive equity', () => {
      const result = calculateTradeInEquity(15000, 9000, 'TD', '2-Key');
      expect(result.type).toBe('positive');
      expect(result.equityAmount).toBe(6000);
    });

    test('should handle negative equity under limit', () => {
      const result = calculateTradeInEquity(8000, 9500, 'TD', '2-Key');
      expect(result.type).toBe('negative');
      expect(result.canRollover).toBe(true);
    });
  });

  describe('Compliance', () => {
    test('should pass compliant deal', () => {
      const result = validateCompliance(380, 5200, 19500, 19500, 'SDA', 'Star3');
      expect(result.overall).toBe(true);
    });
  });

  describe('Tax Calculator', () => {
    test('should calculate Alberta tax (5%)', () => {
      const result = calculateTaxSavings(22500, 8000, 'AB' as any);
      expect(result.taxRate).toBe(0.05);
    });

    test('should calculate Ontario tax (13%)', () => {
      const result = calculateTaxSavings(22500, 8000, 'ON' as any);
      expect(result.taxRate).toBe(0.13);
    });
  });
});
</file>

<file path="src/types/ambient.d.ts">
declare module 'multer';

declare module 'pdf-parse' {
  const pdf: (data: any, options?: any) => Promise<any>;
  export default pdf;
}

declare namespace Express {
  namespace Multer {
    interface File {
      buffer: Buffer;
      originalname?: string;
      mimetype?: string;
      size?: number;
    }
  }
}
</file>

<file path="src/types/pdf-parse.d.ts">
declare module 'pdf-parse' {
  const pdfParse: any;
  export default pdfParse;
}
</file>

<file path="src/utils/logger.ts">
import fs from 'fs';
import path from 'path';
import winston from 'winston';

const logsDir = path.join(process.cwd(), 'logs');
try { if (!fs.existsSync(logsDir)) fs.mkdirSync(logsDir); } catch(_e){}

export const logger = winston.createLogger({
  level: (process.env.LOG_LEVEL || 'info').toLowerCase(),
  format: winston.format.combine(
    winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.printf((info: any) => {
          const { level, message, timestamp, ...meta } = info as any;
          const rest = Object.keys(meta).length ? ' ' + JSON.stringify(meta) : '';
          return `[${timestamp}] ${level}: ${typeof message === 'string' ? message : JSON.stringify(message)}${rest}`;
        })
      )
    }),
    new winston.transports.File({ filename: path.join(logsDir, 'error.log'), level: 'error' }),
    new winston.transports.File({ filename: path.join(logsDir, 'combined.log') })
  ]
});

export default logger;
</file>

<file path="src/api/routes/deals.ts">
import { Router, Request, Response } from 'express';
import { findOptimalDeals } from '../../modules/deal-maximizer';
import { getAllLenderPrograms } from '../../modules/lender-programs';
import { saveDealToGHL } from '../../modules/ghl-integration';
import { FindDealsRequest, FindDealsResponse } from '../../types/types';
import { state } from '../state';

const router = Router();

router.get('/ping', (_req: Request, res: Response) => {
  res.json({ success: true, scope: 'deals', pong: true });
});

router.post('/find', (req: Request, res: Response) => {
  try {
    const request: FindDealsRequest = req.body;

    if (!request.monthlyIncome || !request.lender || !request.tier) {
      return res.status(400).json({
        success: false,
        error: 'Missing required fields: monthlyIncome, lender, tier',
      });
    }

    const deals = findOptimalDeals(request, state.inventory);

    const response: FindDealsResponse = {
      success: true,
      deals,
      summary: {
        totalVehiclesScanned: state.inventory.length,
        totalCompliantDeals: deals.length,
        topDealGrossProfit: deals[0]?.grossProfit.total || 0,
        averageMonthlyPayment:
          deals.length > 0
            ? deals.reduce((sum, d) => sum + d.monthlyPayment, 0) / deals.length
            : 0,
      },
    };

    res.json(response);
  } catch (error) {
    res.status(400).json({
      success: false,
      error: (error as Error).message,
    });
  }
});

router.get('/lenders', (_req: Request, res: Response) => {
  try {
    const lenders = getAllLenderPrograms();
    res.json({ success: true, lenders });
  } catch (error) {
    res.status(500).json({ success: false, error: (error as Error).message });
  }
});

router.post('/save-to-ghl', async (req: Request, res: Response) => {
  try {
    const { customerId, ghlAccessToken, deal } = req.body;

    if (!customerId || !ghlAccessToken || !deal) {
      return res.status(400).json({
        success: false,
        error: 'Missing required fields: customerId, ghlAccessToken, deal',
      });
    }

    const result = await saveDealToGHL(deal, customerId, ghlAccessToken);
    res.json(result);
  } catch (error) {
    res.status(500).json({
      success: false,
      error: (error as Error).message,
    });
  }
});

export default router;
</file>

<file path="src/modules/rules-library.ts">
import { LenderRuleSet } from '../types/types';
import { getContactsForBank } from './lender-contacts';
import { getAllLenderPrograms } from './lender-programs';
import * as fs from 'fs';
import * as path from 'path';

// In-memory dynamic rules store (uploaded monthly via API)
let RULES: LenderRuleSet[] = [];
// Attempt to auto-load bundled default rules so uploads are only needed for new programs
try {
  const seedPath = path.resolve(__dirname, '..', 'config', 'rules-seed.json');
  if (fs.existsSync(seedPath)) {
    const raw = fs.readFileSync(seedPath, 'utf-8');
    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed)) {
      RULES = [...parsed] as LenderRuleSet[];
    }
  }
} catch (_e) {}

// Also load built-in program DB (TD/Santander/SDA) and map to LenderRuleSet
try {
  const db = getAllLenderPrograms();
  const pushFrom = (bankKey: string, canonicalBank: string) => {
    const programs = db[bankKey] || {};
    for (const progKey of Object.keys(programs)) {
      const p = programs[progKey];
      const rule: LenderRuleSet = {
        bank: canonicalBank,
        program: p.tier,
        baseApr: p.rate,
        maxFrontEndAdvance: (p.ltv && p.ltv > 0) ? (p.ltv / 100) : undefined,
        frontAdvanceBase: 'black_book',
        reserve: p.reserve ? {
          fixedByFinancedAmount: [ { minFinanced: 0, maxFinanced: 10000000, amount: p.reserve } ],
        } : undefined,
      } as LenderRuleSet;
      RULES.push(rule);
    }
  };
  pushFrom('TD', 'TD Auto Finance');
  pushFrom('Santander', 'Santander Consumer');
  pushFrom('SDA', 'Scotia Dealer Advantage');
} catch(_e) {}

export function setRules(rules: LenderRuleSet[]) {
  RULES = Array.isArray(rules) ? [...rules] : [];
}

export function addRules(rules: LenderRuleSet[]) {
  if (!Array.isArray(rules)) return;
  RULES.push(...rules);
}

export function listRules(): LenderRuleSet[] {
  // Return a copy, enriching with default contacts when missing
  return RULES.map((r) => {
    if (!r.contacts || !r.contacts.length || !r.lenderAddress) {
      const info = getContactsForBank(r.bank);
      if (info) {
        return {
          ...r,
          contacts: (r.contacts && r.contacts.length ? r.contacts : info.contacts),
          lenderAddress: r.lenderAddress || info.address,
        } as LenderRuleSet;
      }
    }
    return { ...r } as LenderRuleSet;
  });
}

export function findRule(bank: string, program: string): LenderRuleSet | undefined {
  function normBank(s: string): string {
    const x = (s || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
    // map common aliases to canonical tokens
    if (/\btd\b|td auto/.test(x)) return 'td auto finance';
    if (/santander/.test(x)) return 'santander consumer';
    if (/scotia\s*dealer\s*advantage|\bsda\b|scotiabank/.test(x)) return 'scotia dealer advantage';
    if (/eden\s*park/.test(x)) return 'eden park';
    if (/\brbc\b/.test(x)) return 'rbc';
    if (/\bcibc\b/.test(x)) return 'cibc auto finance';
    if (/general\s*bank/.test(x)) return 'general bank of canada';
    if (/\bia\b|\bia\s*auto/.test(x)) return 'ia auto finance';
    if (/autocapital|\bacc\b/.test(x)) return 'autocapital';
    if (/northlake/.test(x)) return 'northlake';
    if (/rifco/.test(x)) return 'rifco';
    if (/servus|connectfirst/.test(x)) return 'servus cu';
    if (/ws\s*leasing|prospera/.test(x)) return 'ws leasing';
    if (/national\s*bank/.test(x)) return 'national bank';
    return x;
  }
  function normProgram(s: string): string {
    const x = (s || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
    // normalize key/tier/star formats
    const keyMatch = x.match(/(key)\s*(\d+)|(\d+)\s*(key)/);
    if (keyMatch) {
      const n = keyMatch[2] || keyMatch[3] || '';
      return `key ${n}`.trim();
    }
    const tierMatch = x.match(/(tier)\s*(\d+)|(\d+)\s*(tier)/);
    if (tierMatch) {
      const n = tierMatch[2] || tierMatch[3] || '';
      return `tier ${n}`.trim();
    }
    const starMatch = x.match(/(star)\s*(\d+)|(\d+)\s*(star)/);
    if (starMatch) {
      const n = starMatch[2] || starMatch[3] || '';
      return `star ${n}`.trim();
    }
    return x;
  }
  const b = normBank(bank);
  const p = normProgram(program);
  return RULES.find(r => normBank(r.bank) === b && normProgram(r.program) === p);
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": [
      "ES2020",
      "DOM"
    ],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node",
    "declaration": true,
    "sourceMap": true,
    "baseUrl": ".",
    "paths": {
      "@config/*": [
        "src/config/*"
      ],
      "@utils/*": [
        "src/utils/*"
      ],
      "@api/*": [
        "src/api/*"
      ],
      "@services/*": [
        "src/services/*"
      ],
      "@types/*": [
        "src/types/*"
      ],
      "@modules/*": [
        "src/modules/*"
      ]
    }
  },
  "include": [
    "src/**/*"
  ],
  "exclude": [
    "node_modules",
    "dist"
  ]
}
</file>

<file path="src/api/state.ts">
import { Vehicle, ApprovalSpec, TradeInfo } from '../types/types';

export type ImageEntry = { mime: string; buf: Buffer };

export const state = {
  inventory: [] as Vehicle[],
  mirroredInventory: [] as Vehicle[],
  lastApproval: null as null | { contactId: string; locationId: string; approval: ApprovalSpec; trade: TradeInfo },
  imageStoreByVin: new Map<string, ImageEntry>(),
  imageStoreById: new Map<string, ImageEntry>(),
};
</file>

<file path="src/server.ts">
import dotenv from 'dotenv';
import express from 'express';
import cors from 'cors';
import path from 'path';
import fs from 'fs';
import config from './config/config';
import logger from './utils/logger';
import { requestLogger, errorHandler, healthCheck } from './api/middleware';
import dealsRouter from './api/routes/deals';
import inventoryRouter from './api/routes/inventory';
import webhooksRouter from './api/routes/webhooks';
import scrapeRouter from './api/routes/scrape';

dotenv.config();

const app = express();
// Allow a separate NEW_PORT so we can run alongside the existing server for verification.
const PORT = Number(process.env.NEW_PORT || process.env.PORT || config.PORT || 10001);

app.use(cors());
app.use(express.json());
app.use(requestLogger);

// API routes (skeletons)
app.use('/api/deals', dealsRouter);
app.use('/api/inventory', inventoryRouter);
app.use('/api/webhooks', webhooksRouter);
app.use('/api/scrape', scrapeRouter);
// Backward-compatibility mounts for legacy paths
app.use('/api', dealsRouter);      // provides /api/lenders, /api/deals/*
app.use('/api', webhooksRouter);   // provides /api/rules/*, /api/approvals/*, /api/ghl/*

// Health
app.get('/health', healthCheck);

// UI routes
app.get('/', (_req, res) => {
  res.redirect('/dashboard');
});

app.get('/dashboard', (_req, res) => {
  res.setHeader('Content-Security-Policy', "default-src 'self'; img-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; font-src 'self' data: https:");
  res.setHeader('Cache-Control', 'no-store');
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(`<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Finance-in-a-Box Dashboard</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
      header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
      button { padding: 8px 12px; border: 1px solid #444; background: #111; color: #fff; border-radius: 6px; cursor: pointer; }
      button:disabled { opacity: .5; cursor: default; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
      .card { border: 1px solid #ddd; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,.05); background: #fff; }
      .card img { width: 100%; height: 180px; object-fit: cover; background: #f2f2f2; }
      .card .body { padding: 12px; display: grid; gap: 6px; }
      .row { display: flex; justify-content: space-between; font-size: 14px; }
      .gross { font-weight: 700; }
      .flags { color: #b30000; font-size: 12px; }
      :root{ --bg:#0b0d10; --panel:#12161b; --muted:#9aa4b2; --text:#e7edf5; --accent:#6ee7b7; --accent2:#60a5fa; --danger:#ef4444; --border:#1f2430; }
      html,body{ background: linear-gradient(180deg,#0b0d10 0%,#0e1217 100%); color: var(--text); margin:0; }
      .container{ max-width: 1200px; margin: 24px auto; padding: 0 16px; }
      .topbar{ position: sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center; padding:14px 20px; background:rgba(10,12,15,.7); backdrop-filter: blur(8px); border-bottom:1px solid var(--border); }
      .brand{ display:flex; align-items:center; gap:12px; }
      .logo{ width:36px; height:36px; border-radius:8px; background: linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; color:#001b12; font-weight:800; }
      .title{ font-weight:700; letter-spacing:.3px; }
      .subtitle{ color: var(--muted); font-size:12px; margin-top:2px; }
      .actions{ display:flex; gap:10px; }
      .btn{ padding:10px 14px; border-radius:8px; border:1px solid var(--border); background:#11161d; color:var(--text); transition: all .15s ease; }
      .btn:hover{ transform: translateY(-1px); border-color:#2a3242; }
      .btn.primary{ background: linear-gradient(135deg,var(--accent),#22c55e); color:#052015; border:0; font-weight:700; }
      .meta{ margin:16px 0; color:var(--muted); }
      .toolbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; background:var(--panel); padding:12px; border:1px solid var(--border); border-radius:12px; margin-bottom:16px; }
      .select,.search{ background:#0e1319; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px 12px; }
      .search{ min-width:240px; }
      .grid{ grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:18px; }
      .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow: 0 6px 18px rgba(0,0,0,.2); overflow:hidden; }
      .card img{ height:190px; }
      .card .body{ padding:14px; }
      .chip{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px; }
      .flags{ color: var(--danger); font-size:12px; }
      .toast{ position: fixed; right: 18px; bottom: 18px; background:#0e1319; border:1px solid var(--border); border-radius:10px; padding:12px 14px; display:none; }
      .toast.show{ display:block; }
      .modal.hidden{ display:none; }
      .modal{ position:fixed; inset:0; display:grid; place-items:center; }
      .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.6); }
      .modal-body{ position:relative; z-index:1; width:min(920px,90vw); background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; display:grid; gap:10px; }
      .textarea{ width:100%; min-height:220px; background:#0e1319; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px; font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .uploader{ display:flex; gap:10px; align-items:center; }
      .modal-actions{ display:flex; justify-content:flex-end; gap:10px; }
      .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; }
      .table{ width:100%; border-collapse: collapse; font-size:13px; }
      .table th,.table td{ border-bottom:1px solid var(--border); padding:8px; text-align:left; }
      .table th{ color:var(--muted); font-weight:600; }
      .hidden{ display:none; }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="brand">
        <div class="logo">FiB</div>
        <div>
          <div class="title">Finance‑in‑a‑Box</div>
          <div class="subtitle">Deal Matrix</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="uploadInventory">Upload Inventory CSV</button>
        <button class="btn" id="uploadRules">Upload Rules</button>
        <button class="btn" id="uploadApproval">Upload Approval</button>
        <button class="btn" id="load">Load Approval</button>
        <button class="btn" id="scrapeDevon">Scrape Devon</button>
        <button class="btn primary" id="score" disabled>Calculate Matrix</button>
      </div>
    </div>
    <div class="container">
      <div id="meta" class="meta"></div>
      <div class="toolbar">
        <div>
          <label for="sortBy" style="color:var(--muted); font-size:12px;">Sort</label>
          <select id="sortBy" class="select">
            <option value="total">Total Gross</option>
            <option value="front">Front Gross</option>
            <option value="back">Back Gross</option>
            <option value="payment">Payment</option>
          </select>
        </div>
        <input id="search" class="search" placeholder="Search VIN, Make, Model" />
        <button class="btn" id="toggleInventory">View Inventory</button>
      </div>
      <div id="grid" class="grid"></div>
      <div id="inventorySection" class="panel hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="font-weight:700;">Inventory</div>
          <div style="color:var(--muted); font-size:12px;">Persisted via Supabase (if configured)</div>
        </div>
        <div style="overflow:auto;">
          <table id="inventoryTable" class="table">
            <thead>
              <tr>
                <th>Stock</th>
                <th>VIN</th>
                <th>Year</th>
                <th>Make</th>
                <th>Model</th>
                <th>Cost</th>
                <th>Price</th>
                <th>BB</th>
                <th>CBB W/R</th>
                <th>Image</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="inventoryModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-body">
        <h3 style="margin:0">Inventory Upload</h3>
        <p style="margin:0;color:var(--muted)">Upload a .csv file or paste CSV content. Columns supported: stock, vin, year, make, model, trim, mileage, color, engine, transmission, your_cost, suggested_price, in_stock, image_url, black_book_value, cbb_wholesale, cbb_retail. Common aliases are also accepted (e.g. cost/price/kms/bb_wholesale/bb_retail). You can also parse a PDF to extract text.</p>
        <div class="uploader">
          <input type="file" id="inventoryFile" accept=".csv,text/csv" />
          <input type="file" id="inventoryPdf" accept="application/pdf" />
          <button class="btn" id="parseInventoryPdf">Parse PDF</button>
          <a class="btn" href="/public/inventory-template.csv" download target="_blank">Download CSV Template</a>
        </div>
        <textarea id="inventoryText" class="textarea" placeholder="stock,vin,year,make,model,your_cost,suggested_price,image_url\nSTK001,2HGFC2F59MH000001,2021,Honda,Civic,18000,21995,https://.../civic.jpg"></textarea>
        <div class="modal-actions">
          <button class="btn" id="closeInventory">Cancel</button>
          <button class="btn" id="saveInventoryFile">Upload File</button>
          <button class="btn primary" id="saveInventory">Upload</button>
        </div>
      </div>
    </div>

    <div id="detailsModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-body">
        <h3 style="margin:0">Deal Details</h3>
        <div id="detailsContent" class="textarea" style="min-height:140px;">
        </div>
        <div class="modal-actions">
          <button class="btn" id="closeDetails">Close</button>
        </div>
      </div>
    </div>

    <div id="approvalModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-body">
        <h3 style="margin:0">Approval Upload</h3>
        <p style="margin:0;color:var(--muted)">Paste approval JSON matching the /api/approvals/ingest schema or parse from a PDF.</p>
        <div class="uploader">
          <input type="file" id="approvalPdf" accept="application/pdf" />
          <button class="btn" id="parseApprovalPdf">Parse PDF</button>
        </div>
        <textarea id="approvalText" class="textarea" placeholder='{
  "contactId": "",
  "locationId": "",
  "approval": { "bank": "EdenPark", "program": "Ride 5", "apr": 12.99, "termMonths": 72, "paymentMin": 350, "paymentMax": 450, "frontCapFactor": 1.4, "province": "AB", "downPayment": 0 },
  "trade": { "allowance": 5000, "acv": 4500, "lienBalance": 1000 }
}'></textarea>
        <div class="modal-actions">
          <button class="btn" id="closeApproval">Cancel</button>
          <button class="btn primary" id="saveApproval">Upload</button>
        </div>
      </div>
    </div>

    <div id="rulesModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-body">
        <h3 style="margin:0">Lender Rules</h3>
        <p style="margin:0;color:var(--muted)">Paste JSON array, upload a .json file, or parse a PDF to extract text.</p>
        <div class="uploader">
          <input type="file" id="rulesFile" accept="application/json" />
          <input type="file" id="rulesPdf" accept="application/pdf" />
          <button class="btn" id="parseRulesPdf">Parse PDF</button>
          <button class="btn" id="loadSample">Load Sample</button>
        </div>
        <textarea id="rulesInput" class="textarea" placeholder="[ {\n  \"bank\": \"EdenPark\",\n  \"program\": \"Ride 5\"\n} ]"></textarea>
        <div class="modal-actions">
          <button class="btn" id="closeRules">Cancel</button>
          <button class="btn primary" id="saveRules">Upload</button>
        </div>
      </div>
    </div>
    <script>
      (function(){
        try {
          var u = '/dashboard.js?ts=' + Date.now();
          fetch(u).then(function(r){
            try {
              console.log('dashboard: fetch /dashboard.js status', r.status, 'ct', r.headers.get('content-type'));
            } catch(_e){}
            return r.text();
          }).then(function(txt){
            try { console.log('dashboard: preview', (txt||'').slice(0,160)); } catch(_e){}
            var s = document.createElement('script');
            s.src = u;
            s.onload = function(){ try { console.log('dashboard: script injected'); } catch(_e){} };
            s.onerror = function(){ try { console.error('dashboard: failed to load /dashboard.js'); } catch(_e){} };
            document.body.appendChild(s);
          }).catch(function(err){ try { console.error('dashboard: fetch failed', err); } catch(_e){} });
        } catch(_e) { try { console.error('dashboard: injection error', _e); } catch(__){} }
      })();
    </script>
  </body>
</html>`);
});

app.get('/dashboard.js', (_req, res) => {
  const distPath = path.join(process.cwd(), 'dist', 'public', 'dashboard.js');
  const srcPath = path.join(process.cwd(), 'src', 'public', 'dashboard.js');
  const p = fs.existsSync(distPath) ? distPath : srcPath;
  res.setHeader('Cache-Control', 'no-store');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.sendFile(path.resolve(p), { headers: { 'Content-Type': 'application/javascript; charset=utf-8' } }, (err) => {
    if (err) {
      res.status(500).send("console.error('Failed to load dashboard.js');");
    }
  });
});

app.get('/public/inventory-template.csv', (_req, res) => {
  const distPath = path.join(process.cwd(), 'dist', 'public', 'inventory-template.csv');
  const srcPath = path.join(process.cwd(), 'src', 'public', 'inventory-template.csv');
  const p = fs.existsSync(distPath) ? distPath : srcPath;
  res.setHeader('Cache-Control', 'no-store');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.sendFile(path.resolve(p), { headers: { 'Content-Type': 'text/csv; charset=utf-8' } }, (err) => {
    if (err) {
      res.status(404).send('CSV template not found');
    }
  });
});

app.get('/favicon.ico', (_req, res) => { res.status(204).end(); });

// Static assets (no-store to avoid stale JS)
app.use(
  '/public',
  express.static(path.join(process.cwd(), 'dist', 'public'), {
    setHeaders: (res) => {
      res.setHeader('Cache-Control', 'no-store');
    },
  })
);

// Global error handler last
app.use(errorHandler);

app.listen(PORT, () => {
  logger.info(`server listening`, { port: PORT });
});

export default app;
</file>

<file path="src/modules/payment-calculator.ts">
/**
 * PAYMENT CALCULATOR MODULE
 * Amortized payment calculation using exact formula: M = P × [r(1+r)^n] / [(1+r)^n - 1]
 * Production-ready with full error handling and JSDoc
 */

import { PaymentCalculationResult, AmortizationEntry } from '../types/types';

/**
 * Calculates monthly payment using amortized formula
 * Formula: M = P × [r(1+r)^n] / [(1+r)^n - 1]
 * where r = monthly interest rate (annual rate ÷ 12 ÷ 100)
 * 
 * @param principal - Loan amount in dollars ($7,500-$100,000)
 * @param annualRate - Annual interest rate as percentage (5-35%)
 * @param numberOfMonths - Loan term in months (24-84)
 * @returns PaymentCalculationResult with monthly payment (rounded to nearest $5), total interest, and amortization schedule
 * @throws Error if validation fails
 */
export function calculateMonthlyPayment(
  principal: number,
  annualRate: number,
  numberOfMonths: number
): PaymentCalculationResult {
  // Validate inputs
  const validationErrors = validatePaymentInputs(principal, annualRate, numberOfMonths);
  if (validationErrors.length > 0) {
    throw new Error(
      `Payment calculation validation failed:\n${validationErrors
        .map((e) => `  - ${e.message}`)
        .join("\n")}`
    );
  }

  // Calculate monthly interest rate
  const monthlyRate = annualRate / 12 / 100;

  // Handle edge case: 0% interest
  let monthlyPaymentRaw: number;
  if (monthlyRate === 0) {
    monthlyPaymentRaw = principal / numberOfMonths;
  } else {
    // Apply amortized formula: M = P × [r(1+r)^n] / [(1+r)^n - 1]
    const numerator = monthlyRate * Math.pow(1 + monthlyRate, numberOfMonths);
    const denominator = Math.pow(1 + monthlyRate, numberOfMonths) - 1;
    monthlyPaymentRaw = principal * (numerator / denominator);
  }

  // Round to nearest $5
  const monthlyPayment = Math.round(monthlyPaymentRaw / 5) * 5;

  // Generate full amortization schedule
  const amortizationSchedule = generateAmortizationSchedule(
    principal,
    monthlyRate,
    monthlyPayment,
    numberOfMonths
  );

  // Calculate totals
  const totalInterest = amortizationSchedule.reduce((sum, entry) => sum + entry.interest, 0);
  const totalAmortized = monthlyPayment * numberOfMonths;

  return {
    monthlyPayment,
    totalInterest: Math.round(totalInterest * 100) / 100,
    totalAmortized,
    amortizationSchedule,
  };
}

/**
 * Validates payment calculation inputs
 * @private
 * @returns Array of validation errors (empty if valid)
 */
function validatePaymentInputs(
  principal: number,
  annualRate: number,
  numberOfMonths: number
): ValidationError[] {
  const errors: ValidationError[] = [];

  // Validate principal
  if (typeof principal !== "number" || isNaN(principal)) {
    errors.push({
      field: "principal",
      value: principal,
      message: "Principal must be a valid number",
    });
  } else if (principal < 7500) {
    errors.push({
      field: "principal",
      value: principal,
      min: 7500,
      message: "Principal must be at least $7,500",
    });
  } else if (principal > 100000) {
    errors.push({
      field: "principal",
      value: principal,
      max: 100000,
      message: "Principal cannot exceed $100,000",
    });
  }

  // Validate annual rate
  if (typeof annualRate !== "number" || isNaN(annualRate)) {
    errors.push({
      field: "annualRate",
      value: annualRate,
      message: "Annual rate must be a valid number",
    });
  } else if (annualRate < 5) {
    errors.push({
      field: "annualRate",
      value: annualRate,
      min: 5,
      message: "Annual rate must be at least 5%",
    });
  } else if (annualRate > 35) {
    errors.push({
      field: "annualRate",
      value: annualRate,
      max: 35,
      message: "Annual rate cannot exceed 35%",
    });
  }

  // Validate number of months
  if (typeof numberOfMonths !== "number" || isNaN(numberOfMonths) || !Number.isInteger(numberOfMonths)) {
    errors.push({
      field: "numberOfMonths",
      value: numberOfMonths,
      message: "Number of months must be a valid integer",
    });
  } else if (numberOfMonths < 24) {
    errors.push({
      field: "numberOfMonths",
      value: numberOfMonths,
      min: 24,
      message: "Loan term must be at least 24 months",
    });
  } else if (numberOfMonths > 84) {
    errors.push({
      field: "numberOfMonths",
      value: numberOfMonths,
      max: 84,
      message: "Loan term cannot exceed 84 months",
    });
  }

  return errors;
}

/**
 * Generates complete amortization schedule
 * @private
 */
function generateAmortizationSchedule(
  principal: number,
  monthlyRate: number,
  monthlyPayment: number,
  numberOfMonths: number
): AmortizationEntry[] {
  const schedule: AmortizationEntry[] = [];
  let remainingBalance = principal;

  for (let month = 1; month <= numberOfMonths; month++) {
    // Calculate interest for this month
    const interestPayment = remainingBalance * monthlyRate;

    // Calculate principal portion
    const principalPayment = monthlyPayment - interestPayment;

    // Update balance
    remainingBalance -= principalPayment;

    // Handle final month rounding
    const finalBalance = month === numberOfMonths ? 0 : remainingBalance;

    schedule.push({
      month,
      payment: monthlyPayment,
      principal: Math.round(principalPayment * 100) / 100,
      interest: Math.round(interestPayment * 100) / 100,
      balance: Math.round(finalBalance * 100) / 100,
    });
  }

  return schedule;
}

/**
 * Get payment summary (for quick lookups without full schedule)
 */
export function getPaymentSummary(
  principal: number,
  annualRate: number,
  numberOfMonths: number
): { monthlyPayment: number; totalInterest: number } {
  const result = calculateMonthlyPayment(principal, annualRate, numberOfMonths);
  return {
    monthlyPayment: result.monthlyPayment,
    totalInterest: result.totalInterest,
  };
}


interface ValidationError {
  field: string;
  value: number;
  min?: number;
  max?: number;
  message: string;
}
</file>

<file path="src/types/types.ts">
/**
 * CENTRAL TYPES FOR FINANCE-IN-A-BOX
 * All TypeScript interfaces used across the system
 */

export type LenderType = 'TD' | 'Santander' | 'SDA';
export type Province = 'AB' | 'BC' | 'SK' | 'MB' | 'ON' | 'QC' | 'NS' | 'NB' | 'PE' | 'NL';

/**
 * Vehicle from inventory
 */
export interface Vehicle {
  id: string;
  vin: string;
  year: number;
  make: string;
  model: string;
  trim?: string;
  mileage: number;
  color?: string;
  engine: string;
  transmission: string;
  cbbWholesale: number;
  cbbRetail: number;
  yourCost: number;
  suggestedPrice: number;
  inStock: boolean;
  imageUrl?: string;
  imageUrls?: string[];
  blackBookValue?: number;
}

/**
 * Customer/Buyer profile
 */
export interface CustomerProfile {
  monthlyIncome: number;
  downPayment: number;
  tradeInValue?: number;
  tradeInBalance?: number;
  creditScore?: number;
  province: Province;
}

/**
 * Request to find deals
 */
export interface FindDealsRequest extends CustomerProfile {
  lender: LenderType;
  tier: string;
  term: number;
  inventoryFilter?: {
    make?: string;
    model?: string;
    maxMileage?: number;
    minYear?: number;
  };
}

/**
 * Calculated deal
 */
export interface Deal {
  id: string;
  rank: number;
  vehicle: Vehicle;
  lender: LenderType;
  tier: string;
  salePrice: number;
  downPayment: number;
  financeAmount: number;
  monthlyPayment: number;
  term: number;
  compliance: ComplianceResult;
  productBundle: ProductBundle;
  grossProfit: GrossProfitBreakdown;
  dealertrackCopy: string;
}

/**
 * Payment calculation result
 */
export interface PaymentCalculationResult {
  monthlyPayment: number;
  totalInterest: number;
  totalAmortized: number;
  amortizationSchedule: AmortizationEntry[];
}

/**
 * Single amortization entry
 */
export interface AmortizationEntry {
  month: number;
  payment: number;
  principal: number;
  interest: number;
  balance: number;
}

/**
 * Trade-in equity result
 */
export interface TradeInEquityResult {
  type: 'positive' | 'negative' | 'zero';
  equityAmount: number;
  canRollover: boolean;
  maxRolloverLimit: number;
  rolledAmount: number;
  note: string;
}

/**
 * Compliance check result
 */
export interface ComplianceResult {
  dsr: number;
  dsrPass: boolean;
  ltv: number;
  ltvPass: boolean;
  overall: boolean;
  warnings: string[];
}

/**
 * Lender program specs
 */
export interface LenderProgram {
  lender: LenderType;
  tier: string;
  rate: number;
  ltv: number;
  maxDsr: number;
  minIncome: number;
  reserve: number;
  fee: number;
  negativeEquityLimit: number;
  rateUpsell?: number;
}

/**
 * Aftermarket product
 */
export interface Product {
  name: string;
  category: 'warranty' | 'gap' | 'tire' | 'appearance';
  retailPrice: number;
  cost: number;
  margin: number;
}

/**
 * Product bundle
 */
export interface ProductBundle {
  products: Product[];
  totalRetail: number;
  totalCost: number;
  totalMargin: number;
}

/**
 * Gross profit breakdown
 */
export interface GrossProfitBreakdown {
  vehicleGross: number;
  lenderReserve: number;
  rateUpsell: number;
  productMargin: number;
  total: number;
}

/**
 * Tax calculation result
 */
export interface TaxResult {
  province: Province;
  taxRate: number;
  salePrice: number;
  taxableBase: number;
  totalTax: number;
  taxSavingsWithTrade: number;
}

/**
 * VIN decoding result
 */
export interface VINDecodingResult {
  year: number;
  make: string;
  model: string;
  body: string;
  engine: string;
  transmission: string;
}

/**
 * Find deals response
 */
export interface FindDealsResponse {
  success: boolean;
  deals: Deal[];
  summary: {
    totalVehiclesScanned: number;
    totalCompliantDeals: number;
    topDealGrossProfit: number;
    averageMonthlyPayment: number;
  };
}

/**
 * GoHighLevel integration response
 */
export interface GHLResponse {
  success: boolean;
  noteId?: string;
  dealLink?: string;
  error?: string;
}

/**
 * Lender approval specification (from GHL webhook)
 */
export type BackCapType = 'percent_of_bb' | 'percent_of_price';

export interface BackCapRule {
  type: BackCapType;
  percent: number; // e.g. 0.2 for 20%
}

export interface ApprovalSpec {
  bank: string;            // e.g. 'TD', 'SDA', 'Santander'
  program: string;         // e.g. '5 key', 'Tier 3'
  apr: number;             // annual percentage rate
  termMonths: number;      // loan term
  paymentMin: number;      // min monthly payment constraint
  paymentMax: number;      // max monthly payment constraint
  frontCapFactor?: number; // optional multiplier on Black Book to cap front-end price
  backCap?: BackCapRule;   // optional cap for back-end as % of BB or price
  province?: Province;     // optional taxation province
  downPayment?: number;    // optional down payment
}

export interface TradeInfo {
  allowance: number;   // trade allowance offered
  acv: number;         // actual cash value of trade
  lienBalance: number; // outstanding loan balance on trade
}

export interface ApprovalIngestPayload {
  contactId: string;
  locationId: string;
  approval: ApprovalSpec;
  trade: TradeInfo;
  blackBook?: {
    overrideVehicleId?: string;
    overrideValue?: number;
  };
}

export interface ScoredVehicleRow {
  vehicleId: string;
  vin: string;
  title: string;
  imageUrl?: string;
  salePrice: number;
  monthlyPayment: number;
  frontGross: number;
  backGross: number;
  totalGross: number;
  flags: string[];
}

export interface ScoreRequest {
  approval?: ApprovalSpec; // if omitted, use last ingested
  trade?: TradeInfo;       // if omitted, use last ingested
}

export interface ScoreResponse {
  approval: ApprovalSpec;
  rows: ScoredVehicleRow[];
}

/**
 * Dynamic lender rules (uploaded monthly, not hard-coded)
 */
export interface ReserveBracket {
  minFinanced: number; // inclusive
  maxFinanced: number; // inclusive
  amount: number;      // fixed reserve/bonus amount
}

export interface ReserveRule {
  // Reserve as a percent of amount financed (e.g., 0.02 for 2%)
  percentOfFinanced?: number;
  // Fixed reserve tiers by amount financed
  fixedByFinancedAmount?: ReserveBracket[];
  // Quality bonus tiers by amount financed
  qualityBonusByFinancedAmount?: ReserveBracket[];
  // Typical chargeback window if applicable (e.g., 180 days)
  chargebackDays?: number;
}

export interface TermByModelYearRule {
  yearFrom: number; // inclusive
  yearTo: number;   // inclusive
  maxTermMonths: number;
}

export interface LenderRuleSet {
  bank: string;              // e.g., 'GBC', 'EdenPark', 'Scotiabank', 'CIBC', 'IA Auto'
  program: string;           // e.g., 'New & Nearly New', 'Ride 5', 'Auto Special'
  // Optional caps; if not provided in ApprovalSpec, these fill in
  frontCapFactor?: number;   // multiplier on Black Book
  backCap?: BackCapRule;     // cap for back-end as % of BB or price
  // Reserves/Bonuses paid by lender
  reserve?: ReserveRule;
  // Lender-imposed max payment call (overrides approval.paymentMax if lower)
  maxPayCall?: number;
  // Eligibility constraints (optional, extend as needed)
  termByModelYear?: TermByModelYearRule[];
}
</file>

<file path="src/api/routes/inventory.ts">
import { Router, Request, Response } from 'express';
import multer from 'multer';
import pdf from 'pdf-parse';
import { state } from '../state';
import { Vehicle } from '../../types/types';
import { loadInventoryFromCSV, enrichWithVinAuditValuations } from '../../modules/inventory-manager';
import { saveInventoryToSupabase, fetchInventoryFromSupabase } from '../../modules/supabase';

const router = Router();
const upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: 15 * 1024 * 1024 } });

router.get('/ping', (_req: Request, res: Response) => {
  res.json({ success: true, scope: 'inventory', pong: true });
});

router.post('/upload-file', upload.single('file'), async (req: Request, res: Response) => {
  try {
    const file = (req as any).file as Express.Multer.File | undefined;
    if (!file) return res.status(400).json({ success: false, error: 'No file provided' });
    const text = file.buffer.toString('utf8');
    let parsed = loadInventoryFromCSV(text);
    parsed = await enrichWithVinAuditValuations(parsed);
    state.inventory = parsed;
    try { await saveInventoryToSupabase(state.inventory); } catch(_e){}
    res.json({ success: true, message: `Loaded ${state.inventory.length} vehicles` });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

router.post('/upload-image', upload.single('file'), async (req: Request, res: Response) => {
  try {
    const file = (req as any).file as Express.Multer.File | undefined;
    const fields = (req as any).body || {};
    if (!file) return res.status(400).json({ success: false, error: 'No file provided' });
    const keyVin = fields.vin ? String(fields.vin).trim() : '';
    const keyId = fields.id ? String(fields.id).trim() : '';
    const entry = { mime: (file as any).mimetype || 'image/jpeg', buf: file.buffer };
    if (keyVin) state.imageStoreByVin.set(keyVin, entry);
    if (keyId) state.imageStoreById.set(keyId, entry);
    if (keyVin) {
      const url = `/api/inventory/image-by-vin/${encodeURIComponent(keyVin)}`;
      for (let i = 0; i < state.inventory.length; i++) if (state.inventory[i].vin === keyVin) state.inventory[i] = { ...state.inventory[i], imageUrl: url };
      for (let i = 0; i < state.mirroredInventory.length; i++) if (state.mirroredInventory[i].vin === keyVin) state.mirroredInventory[i] = { ...state.mirroredInventory[i], imageUrl: url };
    }
    if (keyId) {
      const url2 = `/api/inventory/image/${encodeURIComponent(keyId)}`;
      for (let i = 0; i < state.inventory.length; i++) if (String(state.inventory[i].id) === keyId) state.inventory[i] = { ...state.inventory[i], imageUrl: url2 };
      for (let i = 0; i < state.mirroredInventory.length; i++) if (String(state.mirroredInventory[i].id) === keyId) state.mirroredInventory[i] = { ...state.mirroredInventory[i], imageUrl: url2 };
    }
    res.json({ success: true, message: 'Image uploaded', byVin: !!keyVin, byId: !!keyId });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

router.post('/parse-pdf', upload.single('file'), async (req: Request, res: Response) => {
  try {
    const file = (req as any).file as Express.Multer.File | undefined;
    if (!file) return res.status(400).json({ success: false, error: 'No file provided' });
    const data = await pdf(file.buffer);
    const text = data.text || '';
    res.json({ success: true, text });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

router.get('/image-by-vin/:vin', (req: Request, res: Response) => {
  const vin = String(req.params.vin || '');
  const entry = state.imageStoreByVin.get(vin);
  if (!entry) return res.status(404).end();
  res.setHeader('Cache-Control', 'no-store');
  res.setHeader('Content-Type', entry.mime);
  res.send(entry.buf);
});

router.get('/image/:id', (req: Request, res: Response) => {
  const id = String(req.params.id || '');
  const entry = state.imageStoreById.get(id);
  if (!entry) return res.status(404).end();
  res.setHeader('Cache-Control', 'no-store');
  res.setHeader('Content-Type', entry.mime);
  res.send(entry.buf);
});

router.post('/upload', async (req: Request, res: Response) => {
  try {
    const { csvContent } = req.body;
    if (!csvContent) {
      return res.status(400).json({ success: false, error: 'CSV content required' });
    }
    let parsed = loadInventoryFromCSV(csvContent);
    parsed = await enrichWithVinAuditValuations(parsed);
    state.inventory = parsed;
    try { await saveInventoryToSupabase(state.inventory); } catch(_e){}
    res.json({ success: true, message: `Loaded ${state.inventory.length} vehicles` });
  } catch (error) {
    res.status(400).json({ success: false, error: (error as Error).message });
  }
});

router.get('/', (_req: Request, res: Response) => {
  (async () => {
    try {
      const rows = await fetchInventoryFromSupabase();
      if (rows && rows.length > 0) {
        state.inventory = rows;
      }
    } catch(_e){}
    res.json({ success: true, total: state.inventory.length, vehicles: state.inventory });
  })();
});

router.post('/sync', (req: Request, res: Response) => {
  try {
    const b = req.body || {};
    const id = String(b.id || b.stock || b.vehicleId || b.vehicle_id || b.vin || `WEB-${Date.now()}`);
    const updates: Partial<Vehicle> = {};
    if (b.vin !== undefined) updates.vin = String(b.vin);
    if (b.year !== undefined || b.vehicle_year !== undefined) updates.year = Number(b.year || b.vehicle_year);
    if (b.make !== undefined || b.vehicle_make !== undefined) updates.make = String(b.make || b.vehicle_make);
    if (b.model !== undefined || b.vehicle_model !== undefined) updates.model = String(b.model || b.vehicle_model);
    if (b.trim !== undefined) updates.trim = b.trim;
    if (b.mileage !== undefined) updates.mileage = Number(b.mileage);
    if (b.color !== undefined) updates.color = b.color;
    if (b.engine !== undefined) updates.engine = b.engine;
    if (b.transmission !== undefined) updates.transmission = b.transmission;
    if (b.cbbWholesale !== undefined) updates.cbbWholesale = Number(b.cbbWholesale);
    if (b.cbbRetail !== undefined) updates.cbbRetail = Number(b.cbbRetail);
    if (b.cost !== undefined || b.yourCost !== undefined) updates.yourCost = Number(b.cost || b.yourCost);
    if (b.suggestedPrice !== undefined || b.price !== undefined) updates.suggestedPrice = Number(b.suggestedPrice || b.price);
    if (b.inStock !== undefined) updates.inStock = String(b.inStock).toLowerCase() !== 'false';
    if (b.imageUrl !== undefined || b.image_url !== undefined || b.photoUrl !== undefined) updates.imageUrl = b.imageUrl || b.image_url || b.photoUrl;
    if (b.blackBookValue !== undefined || b.black_book_value !== undefined) updates.blackBookValue = Number(b.blackBookValue ?? b.black_book_value);

    // Update mirrored inventory
    const mi = state.mirroredInventory.findIndex(x => x.id === id);
    if (mi >= 0) state.mirroredInventory[mi] = { ...state.mirroredInventory[mi], ...updates } as Vehicle;
    else state.mirroredInventory.push({ id, ...(updates as any) } as Vehicle);

    // Also update primary inventory if present
    const pi = state.inventory.findIndex(x => x.id === id);
    if (pi >= 0) state.inventory[pi] = { ...state.inventory[pi], ...updates } as Vehicle;

    res.json({ success: true, message: 'Vehicle upserted', vehicleId: id });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

router.get('/mirrored', (_req: Request, res: Response) => {
  res.json({ success: true, total: state.mirroredInventory.length, vehicles: state.mirroredInventory });
});

export default router;
</file>

<file path="src/api/routes/scrape.ts">
import express, { Request, Response } from 'express';
import axios from 'axios';
import { load as cheerioLoad } from 'cheerio';
import { Vehicle } from '../../types/types';

const router = express.Router();

const http = axios.create({
  timeout: 20000,
  maxRedirects: 5,
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-CA,en-US;q=0.9,en;q=0.8',
    'Cache-Control': 'no-cache',
    'Pragma': 'no-cache',
  },
});

async function fetchHtmlHeadless(url: string, referer?: string): Promise<string> {
  let browser: any = null;
  try {
    const mod: any = await import('puppeteer');
    const puppeteer = mod.default || mod;
    browser = await puppeteer.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage'],
    });
    const page = await browser.newPage();
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0 Safari/537.36');
    const extra: Record<string,string> = { 'Accept-Language': 'en-CA,en-US;q=0.9,en;q=0.8' };
    if (referer) extra['Referer'] = referer;
    await page.setExtraHTTPHeaders(extra);
    await page.setRequestInterception(true);
    page.on('request', (req: any) => {
      const rt = req.resourceType();
      if (rt === 'image' || rt === 'font' || rt === 'media' || rt === 'stylesheet') return req.abort();
      req.continue();
    });
    await page.goto(url, { waitUntil: 'networkidle2', timeout: 45000 });
    await page.waitForSelector('body', { timeout: 15000 });
    return await page.content();
  } finally {
    if (browser) { try { await browser.close(); } catch(_e) {} }
  }
}

async function fetchHtml(url: string, referer?: string): Promise<string> {
  try {
    const resp = await http.get(url, { headers: referer ? { Referer: referer } : undefined });
    return resp.data as string;
  } catch(_e) {
    // Fallback to headless browser to bypass bot protection
    return await fetchHtmlHeadless(url, referer);
  }
}

function extractJsonLd(html: string): any[] {
  const results: any[] = [];
  const re = /<script[^>]+type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi;
  let m: RegExpExecArray | null;
  while ((m = re.exec(html)) !== null) {
    const raw = m[1].trim();
    // Some sites wrap multiple JSON objects without array; attempt to parse robustly
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) results.push(...parsed);
      else results.push(parsed);
    } catch (_e) {
      // Try to recover malformed JSON-LD by locating first/last braces
      try {
        const start = raw.indexOf('{');
        const end = raw.lastIndexOf('}');
        if (start >= 0 && end > start) {
          const frag = raw.slice(start, end + 1);
          const parsed = JSON.parse(frag);
          if (Array.isArray(parsed)) results.push(...parsed);
          else results.push(parsed);
        }
      } catch (__e) {}
    }
  }
  return results;
}

function toNumber(input: any): number | undefined {
  if (input === undefined || input === null || input === '') return undefined;
  let s = String(input);
  const neg = /^\(.*\)$/.test(s);
  s = s.replace(/[,$]/g, '').replace(/^\(|\)$/g, '').replace(/\$/g, '');
  const n = parseFloat(s);
  if (isNaN(n)) return undefined;
  return neg ? -n : n;
}

function normalizeVehicleFromJsonLd(obj: any, idx: number, baseUrl?: string): Vehicle | null {
  try {
    const ldType = obj['@type'];
    if (Array.isArray(ldType)) {
      if (!ldType.some((t) => String(t).toLowerCase().includes('vehicle') || String(t).toLowerCase().includes('product'))) {
        // not a vehicle-ish schema
      }
    } else if (ldType && !String(ldType).toLowerCase().includes('vehicle') && !String(ldType).toLowerCase().includes('product')) {
      // pass, may still contain nested vehicle data
    }

    const vin = obj.vehicleIdentificationNumber || obj.vin || obj.hasVIN || '';
    const brand = obj.brand?.name || obj.brand || obj.manufacturer || '';
    const model = obj.model || obj.vehicleModel?.name || '';
    const modelDate = obj.modelDate || obj.productionDate || '';
    const year = Number.parseInt(String(modelDate)) || inferYearFromName(obj.name) || 0;
    const name = obj.name || '';
    const price = toNumber(obj.offers?.price ?? obj.price ?? obj.offers?.[0]?.price);
    const mileage = toNumber(obj.mileageFromOdometer?.value);
    
    const rawImages = Array.isArray(obj.image) ? obj.image : (obj.image ? [obj.image] : []);
    const imageUrls: string[] = [];
    for (const img of rawImages) {
      let imgUrl = typeof img === 'string' ? img : (img?.url || img?.contentUrl || '');
      if (imgUrl) {
        try {
          if (baseUrl && !/^https?:\/\//i.test(imgUrl)) {
            imgUrl = new URL(String(imgUrl), baseUrl).href;
          }
          imageUrls.push(imgUrl);
        } catch(_e) {}
      }
    }
    
    const stock = obj.sku || obj.productID || obj.identifier || obj.serialNumber || vin || `SCR-${Date.now()}-${idx}`;

    const vehicle: Vehicle = {
      id: String(stock),
      vin: String(vin || ''),
      year: year || 0,
      make: String(brand || 'Unknown'),
      model: String(model || (name ? name.split(' ').slice(1).join(' ') : 'Unknown')),
      trim: '',
      mileage: mileage ?? 0,
      color: undefined,
      engine: 'Unknown',
      transmission: 'Unknown',
      cbbWholesale: 0,
      cbbRetail: 0,
      yourCost: 0,
      suggestedPrice: price ?? 0,
      inStock: true,
      imageUrl: imageUrls[0] || undefined,
      imageUrls: imageUrls.length > 0 ? imageUrls : undefined,
      blackBookValue: undefined,
    };

    return vehicle;
  } catch (_e) {
    return null;
  }
}

function inferYearFromName(name?: string): number | undefined {
  if (!name) return undefined;
  const m = name.match(/\b(20\d{2}|19\d{2})\b/);
  return m ? Number.parseInt(m[1]) : undefined;
}

async function fetchVehiclesFromListing(url: string, limit = 20): Promise<Vehicle[]> {
  const out: Vehicle[] = [];
  const html = await fetchHtml(url);
  const blocks = extractJsonLd(html);
  // 1) try direct Vehicle objects in JSON-LD
  const direct: Vehicle[] = [];
  blocks.forEach((b, i) => {
    const v = normalizeVehicleFromJsonLd(b, i, url);
    if (v && (v.vin || v.make || v.model)) direct.push(v);
  });
  if (direct.length > 0) return direct.slice(0, limit);

  // 2) find SearchResultsPage -> itemListElement -> url; fetch detail pages
  const urls: string[] = [];
  for (const b of blocks) {
    const type = b['@type'];
    if (!type) continue;
    const t = Array.isArray(type) ? type.map(String) : [String(type)];
    if (t.some((x) => x.toLowerCase().includes('searchresultspage'))) {
      // Dealer sites vary: try a few shapes
      const items = b.itemListElement || b.hasPart?.itemListElement || [];
      if (Array.isArray(items)) {
        for (const it of items) {
          const u = it?.url || it?.item?.url || it?.mainEntityOfPage?.url;
          if (u) urls.push(String(u));
        }
      }
    }
  }

  // 3) If we still have no URLs, fallback to DOM link discovery with Cheerio
  if (urls.length === 0) {
    try {
      const $ = cheerioLoad(html);
      const candidates = new Set<string>();
      $('a[href]').each((_i: number, el: any) => {
        const href = String($(el).attr('href') || '');
        if (!href) return;
        // Filter likely vehicle detail links
        const h = href.toLowerCase();
        if (h.includes('/used') || h.includes('/new') || h.includes('/vehicle') || h.includes('/inventory')) {
          candidates.add(href);
        }
      });
      const abs = Array.from(candidates)
        .map((h) => (h.startsWith('http') ? h : new URL(h, url).href))
        .filter((h) => h.includes('devonchrysler.com'));
      urls.push(...Array.from(new Set(abs)));
    } catch (_e) {}
  }

  const unique = Array.from(new Set(urls)).slice(0, limit);
  for (let i = 0; i < unique.length; i++) {
    try {
      const u = unique[i].startsWith('http') ? unique[i] : new URL(unique[i], url).href;
      const h = await fetchHtml(u, url);
      const bs = extractJsonLd(h);
      for (let j = 0; j < bs.length; j++) {
        const v = normalizeVehicleFromJsonLd(bs[j], j, u);
        if (v && (v.vin || v.make || v.model)) { out.push(v); break; }
      }
      // If JSON-LD did not produce a vehicle, try DOM parsing heuristics
      if (out.length < i + 1) {
        const domVeh = normalizeVehicleFromDom(h, u, i);
        if (domVeh) out.push(domVeh);
      }
    } catch (_e) {}
  }

  return out.slice(0, limit);
}

function normalizeVehicleFromDom(html: string, pageUrl: string, idx: number): Vehicle | null {
  try {
    const $ = cheerioLoad(html);
    // Name/year/make/model
    const ogTitle = $('meta[property="og:title"]').attr('content') || '';
    const title = ogTitle || $('title').text().trim();
    const year = inferYearFromName(title) || 0;
    
    // Capture ALL images from gallery/carousel and fallback to og:image
    const imageUrls: string[] = [];
    const gallerySelectors = [
      '.vehicle-gallery img[src]',
      '.image-gallery img[src]',
      '.carousel img[src]',
      '.slider img[src]',
      '[class*="gallery"] img[src]',
      '[class*="photo"] img[src]',
      '[id*="gallery"] img[src]',
      '[data-gallery] img[src]'
    ];
    
    for (const selector of gallerySelectors) {
      $(selector).each((_i: number, el: any) => {
        let src = $(el).attr('src') || $(el).attr('data-src') || $(el).attr('data-lazy');
        if (src && !src.includes('placeholder') && !src.includes('loading')) {
          try {
            if (!/^https?:/i.test(src)) src = new URL(src, pageUrl).href;
            if (!imageUrls.includes(src)) imageUrls.push(src);
          } catch(_e) {}
        }
      });
    }
    
    // Fallback to og:image and first img if no gallery found
    if (imageUrls.length === 0) {
      const ogImage = $('meta[property="og:image"]').attr('content');
      if (ogImage) {
        try {
          const resolved = !/^https?:/i.test(ogImage) ? new URL(ogImage, pageUrl).href : ogImage;
          imageUrls.push(resolved);
        } catch(_e) {}
      }
      
      $('img[src]').each((_i: number, el: any) => {
        if (imageUrls.length >= 10) return false;
        let src = $(el).attr('src');
        if (src && !src.includes('logo') && !src.includes('icon') && !src.includes('placeholder')) {
          try {
            if (!/^https?:/i.test(src)) src = new URL(src, pageUrl).href;
            if (!imageUrls.includes(src)) imageUrls.push(src);
          } catch(_e) {}
        }
      });
    }
    
    // Price heuristics
    let price: number | undefined;
    const priceMeta = $('meta[itemprop="price"]').attr('content') || $('meta[property="product:price:amount"]').attr('content');
    if (priceMeta) price = toNumber(priceMeta) as number | undefined;
    if (price === undefined) {
      // Find largest numeric under elements containing 'price'
      const priceTexts: string[] = [];
      $('[class*="price"], [id*="price"], .price, .final-price').each((_i: number, el: any) => {
        const t = $(el).text(); if (t) priceTexts.push(t);
      });
      const nums = priceTexts.map((t) => toNumber(t)).filter((n) => typeof n === 'number') as number[];
      if (nums.length) price = Math.max(...nums);
    }
    // VIN & Stock & Mileage heuristics
    const whole = $('body').text();
    let vin = '';
    const mVin = whole.match(/\bVIN[:\s]*([A-HJ-NPR-Z0-9]{17})\b/i);
    if (mVin) vin = mVin[1].toUpperCase();
    let stock = '';
    const mStk = whole.match(/\bStock[:#\s]*([A-Za-z0-9-]+)\b/i);
    if (mStk) stock = mStk[1];
    let mileage = 0;
    const mMil = whole.match(/([0-9][0-9,\.]*)\s*(km|kms|kilometers|kilometres)\b/i);
    if (mMil) {
      const n = parseFloat(mMil[1].replace(/[,\.]/g, ''));
      if (!isNaN(n)) mileage = n;
    }
    // Make/Model from title tokens if possible
    let make = '';
    let model = '';
    if (title) {
      const parts = title.split(/\s+/);
      const yIdx = parts.findIndex((p: string) => /^(19|20)\d{2}$/.test(p));
      const after = yIdx >= 0 ? parts.slice(yIdx + 1) : parts;
      if (after.length) {
        make = after[0];
        model = after.slice(1).join(' ');
      }
    }
    const id = stock || vin || `SCR-DOM-${Date.now()}-${idx}`;
    const vehicle: Vehicle = {
      id: id,
      vin: vin,
      year: year,
      make: make || 'Unknown',
      model: model || 'Unknown',
      trim: '',
      mileage: mileage,
      color: undefined,
      engine: 'Unknown',
      transmission: 'Unknown',
      cbbWholesale: 0,
      cbbRetail: 0,
      yourCost: 0,
      suggestedPrice: price ?? 0,
      inStock: true,
      imageUrl: imageUrls[0] || undefined,
      imageUrls: imageUrls.length > 0 ? imageUrls : undefined,
      blackBookValue: undefined,
    };
    return vehicle;
  } catch(_e) {
    return null;
  }
}

router.get('/devon', async (req: Request, res: Response) => {
  try {
    const base = 'https://www.devonchrysler.com';
    const path = (req.query.path as string) || '/inventory/';
    const limit = Math.min(Math.max(Number(req.query.limit) || 20, 1), 100);
    const url = new URL(path, base).href;
    const vehicles = await fetchVehiclesFromListing(url, limit);
    res.json({ success: true, total: vehicles.length, vehicles });
  } catch (e) {
    const err: any = e;
    const status = err?.response?.status;
    const statusText = err?.response?.statusText;
    res.status(500).json({ success: false, error: (err?.message || 'scrape failed'), status, statusText });
  }
});

export default router;
</file>

<file path="src/api/routes/webhooks.ts">
import { Router, Request, Response } from 'express';
import multer from 'multer';
import pdf from 'pdf-parse';
import axios from 'axios';
import { listRules, setRules, addRules } from '../../modules/rules-library';
import { scoreInventory } from '../../modules/approvals-engine';
import { ApprovalIngestPayload, LenderRuleSet, ScoreRequest, ScoreResponse } from '../../types/types';
import { state } from '../state';

const router = Router();
const upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: 15 * 1024 * 1024 } });

router.get('/ping', (_req: Request, res: Response) => {
  res.json({ success: true, scope: 'webhooks', pong: true });
});

// Rules endpoints
router.get('/rules', (_req: Request, res: Response) => {
  res.json({ success: true, rules: listRules() });
});

router.post('/rules/upload', (req: Request, res: Response) => {
  try {
    const body = req.body || {};
    const rules: LenderRuleSet[] = Array.isArray(body) ? body : (body.rules || []);
    const mode: 'replace' | 'append' = body.mode === 'append' ? 'append' : 'replace';
    if (!Array.isArray(rules) || rules.length === 0) {
      return res.status(400).json({ success: false, error: 'No rules provided' });
    }
    if (mode === 'append') addRules(rules);
    else setRules(rules);
    res.json({ success: true, total: listRules().length });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

router.post('/rules/parse-pdf', upload.single('file'), async (req: Request, res: Response) => {
  try {
    const file = (req as any).file as Express.Multer.File | undefined;
    if (!file) return res.status(400).json({ success: false, error: 'No file provided' });
    const data = await pdf(file.buffer);
    res.json({ success: true, text: data.text || '' });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

// Approvals endpoints
router.post('/approvals/parse-pdf', upload.single('file'), async (req: Request, res: Response) => {
  try {
    const file = (req as any).file as Express.Multer.File | undefined;
    if (!file) return res.status(400).json({ success: false, error: 'No file provided' });
    const data = await pdf(file.buffer);
    const text = data.text || '';
    const suggestion: any = { approval: {}, trade: {}, vehicle: {}, customer: {} };
    
    const bankMatch = text.match(/(?:Bank|Lender)\s*[:\-]\s*([A-Za-z0-9 &\-]+)/i);
    if (bankMatch) suggestion.approval.bank = bankMatch[1].trim();
    
    const programMatch = text.match(/(?:Program|Product)\s*[:\-]\s*([^\n]+)/i);
    if (programMatch) suggestion.approval.program = programMatch[1].trim();
    
    const aprMatch = text.match(/(?:Annual Interest Rate|APR|Rate)\s*[:\-]?\s*(\d{1,2}(?:\.\d{1,2})?)\s*%?/i);
    if (aprMatch) suggestion.approval.apr = Number(aprMatch[1]);
    
    const termMatch = text.match(/(?:Term of Borrowing|Term|Months)\s*[:\-]?\s*(\d{2,3})/i);
    if (termMatch) suggestion.approval.termMonths = Number(termMatch[1]);
    
    const payRange = text.match(/Payment[^\d]*(\d{2,4})(?:[^\d]+|\s*to\s*)(\d{2,4})/i);
    if (payRange) { 
      suggestion.approval.paymentMin = Number(payRange[1]); 
      suggestion.approval.paymentMax = Number(payRange[2]); 
    }
    
    const installmentMatch = text.match(/(?:Installment Payment|Payment Frequency|Payment)\s*[:\-]?\s*\$?\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i);
    if (installmentMatch) {
      const amount = parseFloat(installmentMatch[1].replace(/,/g, ''));
      if (!payRange) {
        suggestion.approval.paymentMin = amount;
        suggestion.approval.paymentMax = amount;
      }
    }
    
    const amountFinancedMatch = text.match(/(?:Amount Financed|Financed Amount)\s*[:\-]?\s*\$?\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i);
    if (amountFinancedMatch) {
      suggestion.approval.amountFinanced = parseFloat(amountFinancedMatch[1].replace(/,/g, ''));
    }
    
    const residualMatch = text.match(/(?:Residual Value|Residual)\s*[:\-]?\s*\$?\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i);
    if (residualMatch) {
      suggestion.approval.residualValue = parseFloat(residualMatch[1].replace(/,/g, ''));
    }
    
    const applicationMatch = text.match(/(?:Application|App)\s*#?\s*[:\-]?\s*([A-Z0-9\-]+)/i);
    if (applicationMatch) suggestion.customer.applicationNumber = applicationMatch[1].trim();
    
    const customerMatch = text.match(/(?:Customer|Applicant|Name)\s*[:\-]\s*([A-Za-z\s\-]+?)(?:\n|Dealer|Co-Applicant)/i);
    if (customerMatch) suggestion.customer.name = customerMatch[1].trim();
    
    const dealerMatch = text.match(/(?:Dealer Name|Dealership)\s*[:\-]\s*([^\n]+)/i);
    if (dealerMatch) suggestion.customer.dealerName = dealerMatch[1].trim();
    
    const vinMatch = text.match(/(?:VIN|Vehicle Identification Number)\s*[:\-]?\s*([A-HJ-NPR-Z0-9]{17})/i);
    if (vinMatch) suggestion.vehicle.vin = vinMatch[1].toUpperCase();
    
    const yearMatch = text.match(/(?:Model|Year)\s*[:\-]?\s*(20\d{2}|19\d{2})/i);
    if (yearMatch) suggestion.vehicle.year = parseInt(yearMatch[1]);
    
    const makeModelMatch = text.match(/(?:Model|Vehicle)\s*[:\-]?\s*(20\d{2}|19\d{2})?\s*([A-Za-z]+)\s+([A-Za-z0-9\s\-]+?)(?:\n|VIN|Odometer)/i);
    if (makeModelMatch) {
      if (makeModelMatch[1] && !suggestion.vehicle.year) suggestion.vehicle.year = parseInt(makeModelMatch[1]);
      suggestion.vehicle.make = makeModelMatch[2].trim();
      suggestion.vehicle.model = makeModelMatch[3].trim();
    }
    
    const odometerMatch = text.match(/(?:Odometer|Mileage|KM)\s*[:\-]?\s*(\d+(?:,\d{3})*)/i);
    if (odometerMatch) {
      suggestion.vehicle.odometer = parseInt(odometerMatch[1].replace(/,/g, ''));
    }
    
    const conditionsMatch = text.match(/(?:Conditions|Lender Comments|Comments)\s*[:\-]?\s*([^\n]+(?:\n(?!(?:Application|Customer|Dealer|Vehicle|VIN|Model|Amount|Term|Payment|Rate|Lender))[^\n]+)*)/i);
    if (conditionsMatch) {
      suggestion.approval.conditions = conditionsMatch[1].trim();
    }
    
    const paymentFreqMatch = text.match(/(?:Payment Frequency)\s*[:\-]?\s*(Weekly|Bi-Weekly|Monthly|Semi-Monthly)/i);
    if (paymentFreqMatch) {
      suggestion.approval.paymentFrequency = paymentFreqMatch[1].trim();
    }
    
    res.json({ success: true, text, suggestion });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

router.post('/approvals/ingest', (req: Request, res: Response) => {
  try {
    const payload: ApprovalIngestPayload = req.body;
    if (!payload?.contactId || !payload?.locationId || !payload?.approval || !payload?.trade) {
      return res.status(400).json({ success: false, error: 'Missing contactId, locationId, approval, or trade' });
    }
    state.lastApproval = {
      contactId: payload.contactId,
      locationId: payload.locationId,
      approval: payload.approval,
      trade: payload.trade,
    };
    if (payload.blackBook?.overrideVehicleId && payload.blackBook?.overrideValue != null) {
      const id = payload.blackBook.overrideVehicleId;
      const vi = state.mirroredInventory.findIndex(v => v.id === id);
      if (vi >= 0) state.mirroredInventory[vi] = { ...state.mirroredInventory[vi], blackBookValue: Number(payload.blackBook.overrideValue) };
    }
    res.json({ success: true });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

router.get('/approvals/last', (_req: Request, res: Response) => {
  if (!state.lastApproval) return res.json({ success: true, hasApproval: false });
  res.json({ success: true, hasApproval: true, lastApproval: state.lastApproval });
});

router.post('/approvals/score', (req: Request, res: Response) => {
  try {
    const body: ScoreRequest = req.body || {};
    const approval = body.approval || state.lastApproval?.approval;
    const trade = body.trade || state.lastApproval?.trade;
    if (!approval || !trade) return res.status(400).json({ success: false, error: 'Missing approval or trade (ingest first or include in request)' });
    if (state.mirroredInventory.length === 0 && state.inventory.length > 0) {
      state.mirroredInventory = state.inventory;
    }
    const rows = scoreInventory(state.mirroredInventory, approval, trade);
    const response: ScoreResponse = { approval, rows };
    res.json({ success: true, ...response });
  } catch (e) {
    res.status(400).json({ success: false, error: (e as Error).message });
  }
});

// Generic webhook
router.post('/ghl/push-selected', async (req: Request, res: Response) => {
  try {
    const { contactId, selected, webhookUrl } = req.body || {};
    const url = webhookUrl || (process.env.GHL_INBOUND_WEBHOOK_URL as string);
    if (!contactId || !selected || !url) {
      return res.status(400).json({ success: false, error: 'Missing contactId, selected, or webhook URL' });
    }
    const payload = { contactId, selected };
    const { data } = await axios.post(url, payload, { headers: { 'Content-Type': 'application/json' }, timeout: 15000 });
    res.json({ success: true, providerResponse: data });
  } catch (e) {
    res.status(500).json({ success: false, error: (e as Error).message });
  }
});

export default router;
</file>

<file path="src/modules/approvals-engine.ts">
import { Vehicle, ApprovalSpec, TradeInfo, ScoredVehicleRow, Province, BackCapRule } from '../types/types';
import { calculateTaxSavings } from './tax-calculator';
import { getPaymentSummary } from './payment-calculator';
import { findRule } from './rules-library';

const DEFAULT_FEE = 810;
const DEFAULT_PROVINCE: Province = 'AB';

function computeMonthlyPayment(
  salePrice: number,
  vehicle: Vehicle,
  approval: ApprovalSpec,
  trade: TradeInfo,
  termOverride?: number
): number {
  const province = approval.province || DEFAULT_PROVINCE;
  const down = approval.downPayment || 0;

  const equity = trade.allowance - trade.lienBalance; // negative means rolled in
  const tax = calculateTaxSavings(salePrice, trade.allowance, province);
  const principal = salePrice - down - equity + DEFAULT_FEE + tax.totalTax;

  const { monthlyPayment } = getPaymentSummary(
    Math.max(0, principal),
    approval.apr,
    termOverride ?? approval.termMonths
  );
  return monthlyPayment;
}

function computePrincipal(
  salePrice: number,
  approval: ApprovalSpec,
  trade: TradeInfo,
  province: Province = DEFAULT_PROVINCE
): number {
  const down = approval.downPayment || 0;
  const equity = trade.allowance - trade.lienBalance; // negative means rolled in
  const tax = calculateTaxSavings(salePrice, trade.allowance, province);
  const principal = salePrice - down - equity + DEFAULT_FEE + tax.totalTax;
  return Math.max(0, principal);
}

function calcGrossParts(
  salePrice: number,
  vehicle: Vehicle,
  approval: ApprovalSpec,
  trade: TradeInfo
): { front: number; back: number } {
  const overAllowance = Math.max(0, trade.allowance - trade.acv);
  const front = (salePrice - vehicle.yourCost) - overAllowance;

  let back = 0;
  if (approval.backCap) {
    const bb = vehicle.blackBookValue ?? 0;
    if (approval.backCap.type === 'percent_of_bb') {
      back = approval.backCap.percent * bb;
    } else {
      back = approval.backCap.percent * salePrice;
    }
  }
  return { front, back };
}

function findMaxPriceWithinPayment(
  minPrice: number,
  maxPrice: number,
  vehicle: Vehicle,
  approval: ApprovalSpec,
  trade: TradeInfo,
  paymentMin: number,
  paymentMax: number,
  termMonthsEff: number
): { price: number; payment: number; fitsRange: boolean } {
  let lo = minPrice;
  let hi = maxPrice;
  let best = { price: minPrice, payment: computeMonthlyPayment(minPrice, vehicle, approval, trade, termMonthsEff), fitsRange: false };

  // if even minPrice exceeds paymentMax, search lower than minPrice is impossible -> no fit
  if (best.payment > paymentMax) {
    return best; // not in range
  }

  // Binary search highest price whose payment ≤ paymentMax
  for (let i = 0; i < 40; i++) {
    const mid = (lo + hi) / 2;
    const pay = computeMonthlyPayment(mid, vehicle, approval, trade, termMonthsEff);
    if (pay <= paymentMax) {
      best = { price: mid, payment: pay, fitsRange: pay >= paymentMin };
      lo = mid;
    } else {
      hi = mid;
    }
  }
  return best;
}

export function scoreInventory(
  inventory: Vehicle[],
  approval: ApprovalSpec,
  trade: TradeInfo
): ScoredVehicleRow[] {
  const rows: ScoredVehicleRow[] = [];

  for (const v of inventory) {
    const flags: string[] = [];
    const bb = v.blackBookValue;
    if (bb == null || isNaN(bb)) {
      flags.push('missing_black_book');
      continue;
    }
    if (v.yourCost == null || isNaN(v.yourCost)) {
      flags.push('missing_cost');
      continue;
    }

    // Load dynamic lender rule if available
    const rule = findRule(approval.bank, approval.program);

    // Effective caps & constraints
    const frontCapFactorEff = approval.frontCapFactor ?? rule?.frontCapFactor;
    const backCapEff: BackCapRule | undefined = approval.backCap ?? rule?.backCap;

    // Term may be constrained by model year
    let termMonthsEff = approval.termMonths;
    if (rule?.termByModelYear && Array.isArray(rule.termByModelYear)) {
      for (const t of rule.termByModelYear) {
        if (v.year >= t.yearFrom && v.year <= t.yearTo) {
          termMonthsEff = Math.min(termMonthsEff, t.maxTermMonths);
        }
      }
    }

    // Payment call cap from lender rule (if lower than approval)
    const paymentMaxEff = Math.min(approval.paymentMax, rule?.maxPayCall ?? Number.POSITIVE_INFINITY);

    const frontCap = frontCapFactorEff != null ? bb * frontCapFactorEff : Number.POSITIVE_INFINITY;
    const minPrice = Math.max(v.yourCost, 0);
    const maxPrice = Math.max(minPrice, Math.min(frontCap, minPrice + 100000));

    const best = findMaxPriceWithinPayment(
      minPrice,
      maxPrice,
      v,
      approval,
      trade,
      approval.paymentMin,
      paymentMaxEff,
      termMonthsEff
    );

    // Front gross
    const overAllowance = Math.max(0, trade.allowance - trade.acv);
    const front = (best.price - v.yourCost) - overAllowance;

    // Compute amount financed (principal) for reserve calculations
    const province = approval.province || DEFAULT_PROVINCE;
    const principal = computePrincipal(best.price, approval, trade, province);

    // Reserve/bonus computation from rules
    let reserve = 0;
    if (rule?.reserve) {
      if (rule.reserve.percentOfFinanced) {
        reserve += rule.reserve.percentOfFinanced * principal;
      }
      if (Array.isArray(rule.reserve.fixedByFinancedAmount)) {
        const br = rule.reserve.fixedByFinancedAmount.find(b => principal >= b.minFinanced && principal <= b.maxFinanced);
        if (br) reserve += br.amount;
      }
      if (Array.isArray(rule.reserve.qualityBonusByFinancedAmount)) {
        const qb = rule.reserve.qualityBonusByFinancedAmount.find(b => principal >= b.minFinanced && principal <= b.maxFinanced);
        if (qb) reserve += qb.amount;
      }
    }

    // Apply back-end cap if present
    if (backCapEff) {
      let capAmt = 0;
      if (backCapEff.type === 'percent_of_bb') capAmt = backCapEff.percent * (bb ?? 0);
      else capAmt = backCapEff.percent * best.price;
      reserve = Math.min(reserve, capAmt);
    }

    const back = Math.max(0, Math.round(reserve));
    const totalGross = Math.max(0, Math.round((front + back) * 100) / 100);

    if (!best.fitsRange) {
      flags.push('payment_out_of_range');
    }

    rows.push({
      vehicleId: v.id,
      vin: v.vin,
      title: `${v.year} ${v.make} ${v.model}`,
      imageUrl: v.imageUrl,
      salePrice: Math.round(best.price),
      monthlyPayment: Math.round(best.payment),
      frontGross: Math.round(front),
      backGross: Math.round(back),
      totalGross,
      flags,
    });
  }

  return rows.sort((a, b) => b.totalGross - a.totalGross);
}
</file>

<file path="src/modules/inventory-manager.ts">
/**
 * MODULE 9: INVENTORY MANAGER
 * Handles CSV loading, vehicle parsing, VIN decoding
 */

import { Vehicle } from '../types/types';
import { decodeVIN, getVehicleValuation } from './vin-decoder';

export function loadInventoryFromCSV(csvContent: string): Vehicle[] {
  const lines = csvContent.trim().split('\n');
  if (lines.length < 2) throw new Error('CSV must have header and at least one data row');
  const normalize = (s: string) => s.trim().toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
  const header = parseCSVLine(lines[0]).map(h => normalize(h));
  const vehicles: Vehicle[] = [];

  for (let i = 1; i < lines.length; i++) {
    const row = parseCSVLine(lines[i]).map(v => v.trim());
    const vehicleData: Record<string, any> = {};

    header.forEach((col, idx) => {
      vehicleData[col] = row[idx];
    });

    // Helpers for flexible header mapping
    const pick = (...keys: string[]) => {
      for (const k of keys) {
        if (vehicleData[k] !== undefined && vehicleData[k] !== '') return vehicleData[k];
      }
      return undefined;
    };

    const num = (val: any, dflt = 0): number => {
      if (val === undefined || val === null || val === '') return dflt;
      let s = String(val).trim();
      const parenNeg = /^\(.*\)$/.test(s);
      const minusNeg = /^\s*-/.test(s);
      const isNeg = parenNeg || minusNeg;
      s = s.replace(/[^0-9.()\-]/g, '');
      s = s.replace(/[()]/g, '');
      s = s.replace(/^\-/, '');
      const n = parseFloat(s);
      if (isNaN(n)) return dflt;
      return isNeg ? -n : n;
    };

    try {
      const vin = (pick('vin') || '') as string;
      const vinData = vin.length === 17 ? decodeVIN(vin) : null;

      const csvMake = (pick('make','vehicle_make','veh_make','manufacturer','brand') as string) || '';
      const csvModel = (pick('model','vehicle_model') as string) || '';
      const csvYear = (pick('year','vehicle_year') as string) || '';
      const vehicle: Vehicle = {
        id: (pick('stock','stock_number','stocknum','stockno','stock_no','stockid','stock_id','id','vehicleid','vehicle_id') as string) || `STOCK-${i}`,
        vin,
        year: (parseInt(csvYear) || 0) || (vinData?.year || 0),
        make: (csvMake || vinData?.make || 'Unknown'),
        model: (csvModel || vinData?.model || 'Unknown'),
        trim: (pick('trim') as string) || '',
        mileage: num(pick('mileage','kms','km','kilometers','odometer','odometer_km'), 0) || 0,
        color: (pick('color','exterior_color') as string) || '',
        engine: vinData?.engine || (pick('engine','motor') as string) || 'Unknown',
        transmission: (pick('transmission','trans','gearbox') as string) || 'Unknown',
        cbbWholesale:
          num(pick('cbb_wholesale','cbbwholesale','bb_wholesale','bbwholesale','blackbook_wholesale','black_book_wholesale','bbw','bb_whl')), 
        cbbRetail:
          num(pick('cbb_retail','cbbretail','bb_retail','bbretail','blackbook_retail','black_book_retail','bbr','bb_rtl')),
        yourCost:
          num(pick(
            'your_cost','yourcost','cost','purchase_cost','our_cost','acquisition_cost','base_cost','vehicle_cost','unit_cost','net_cost','cost_value',
            'inventory_value','inventoryvalue','inventory','inv_value','invvalue','your_cost_$','yourcost$','your_cost$','cost_$',
            'inventory_value_$','inventory_value$','inventory_$','inventory$','inv_value_$','invvalue_$','inv_$','inv$',
            'buy_cost','buy_price','purchase_price','acquisition_price'
          )),
        suggestedPrice:
          num(pick('suggested_price','suggestedprice','price','retail_price','list_price','asking_price','sale_price','msrp','retail','retail_$','retail_value','sale_price_$','asking','retail$')),
        inStock: (function(){
          const v = (pick('in_stock','instock','available','status') as string) || '';
          const val = String(v).toLowerCase();
          if (!val) return true;
          return !(val === 'false' || val === 'no' || val === '0' || val === 'sold' || val === 'unavailable');
        })(),
        imageUrl: (pick('image_url','imageurl','image','photo_url','photourl','photo','picture_url','picture') as string) || undefined,
        blackBookValue: (function(){
          const b = pick('black_book_value','blackbook','bb','bb_value','black_book','bbv','black_book$','blackbook_value');
          const n = num(b, NaN);
          return isNaN(n) ? undefined : n;
        })(),
      };

      vehicles.push(vehicle);
    } catch (e) {
      console.warn(`Skipping row ${i + 1}: ${(e as Error).message}`);
    }
  }

  return vehicles;
}

export function addVehicle(vehicle: Vehicle, inventory: Vehicle[]): Vehicle[] {
  return [...inventory, vehicle];
}

export function removeVehicle(vehicleId: string, inventory: Vehicle[]): Vehicle[] {
  return inventory.filter(v => v.id !== vehicleId);
}

export function updateVehicle(vehicleId: string, updates: Partial<Vehicle>, inventory: Vehicle[]): Vehicle[] {
  return inventory.map(v =>
    v.id === vehicleId ? { ...v, ...updates } : v
  );
}

export async function enrichWithVinAuditValuations(inventory: Vehicle[]): Promise<Vehicle[]> {
  const key = process.env.VINAUDIT_API_KEY;
  if (!key) return inventory;

  const updated: Vehicle[] = [];
  for (const v of inventory) {
    try {
      const valuation = await getVehicleValuation(v.vin, v.mileage);
      updated.push({
        ...v,
        cbbWholesale: valuation.wholesale,
        cbbRetail: valuation.retail,
      });
    } catch (_e) {
      updated.push(v);
    }
  }
  return updated;
}

// Robust CSV line parser that handles quotes, commas, and escaped quotes
function parseCSVLine(line: string): string[] {
  const result: string[] = [];
  let current = '';
  let insideQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const next = line[i + 1];

    if (char === '"' && next === '"') { // escaped quote
      current += '"';
      i++;
      continue;
    }

    if (char === '"') {
      insideQuotes = !insideQuotes;
      continue;
    }

    if (char === ',' && !insideQuotes) {
      result.push(current);
      current = '';
      continue;
    }

    current += char;
  }

  result.push(current);
  return result;
}
</file>

<file path="src/public/dashboard.js">
(function(){
  'use strict';

  try { console.log('dashboard.js loaded'); } catch(_e) {}
  try { window.addEventListener('error', function(e){ try{ console.error('dashboard error', e.error || e.message || e); var t=document.getElementById('toast'); if(t){ t.textContent='Error: ' + (e.message || 'check console'); t.classList.add('show'); setTimeout(function(){ t.classList.remove('show'); }, 3000);} }catch(_ee){} }); } catch(_e) {}

  var meta = document.getElementById('meta');
  var grid = document.getElementById('grid');
  var toastEl = document.getElementById('toast');
  var toggleInventoryBtn = document.getElementById('toggleInventory');
  var inventorySection = document.getElementById('inventorySection');
  var inventoryTable = document.getElementById('inventoryTable');

  var detailsModal = document.getElementById('detailsModal');
  var detailsContent = document.getElementById('detailsContent');
  var closeDetails = document.getElementById('closeDetails');

  var rulesModal = document.getElementById('rulesModal');
  var rulesInput = document.getElementById('rulesInput');
  var rulesFile = document.getElementById('rulesFile');
  var rulesPdf = document.getElementById('rulesPdf');
  var parseRulesPdf = document.getElementById('parseRulesPdf');

  var inventoryModal = document.getElementById('inventoryModal');
  var inventoryFile = document.getElementById('inventoryFile');
  var inventoryText = document.getElementById('inventoryText');
  var inventoryPdf = document.getElementById('inventoryPdf');
  var parseInventoryPdf = document.getElementById('parseInventoryPdf');
  var saveInventoryFile = document.getElementById('saveInventoryFile');

  var approvalModal = document.getElementById('approvalModal');
  var approvalText = document.getElementById('approvalText');
  var approvalPdf = document.getElementById('approvalPdf');
  var parseApprovalPdf = document.getElementById('parseApprovalPdf');

  var sortBy = document.getElementById('sortBy');
  var search = document.getElementById('search');

  var lastApproval = null;
  var currentRows = [];
  var currentInventory = [];
  var fileTextCache = '';
  var invFileTextCache = '';

  function toast(msg){
    try{ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(function(){ toastEl.classList.remove('show'); }, 2200); }catch(_e){}
  }

  function openRules(){ rulesModal.classList.remove('hidden'); }
  function closeRules(){ rulesModal.classList.add('hidden'); }
  function openInventory(){ inventoryModal.classList.remove('hidden'); }
  function closeInventory(){ inventoryModal.classList.add('hidden'); }
  function openApproval(){ approvalModal.classList.remove('hidden'); }
  function closeApproval(){ approvalModal.classList.add('hidden'); }

  function fmt$(n){ try{ return '$' + Number(n||0).toLocaleString(); }catch(e){ return '$' + n; } }

  function renderRows(){
    var q = (search.value||'').trim().toLowerCase();
    var arr = currentRows.slice();
    if (q) arr = arr.filter(function(r){ return (r.vin||'').toLowerCase().indexOf(q)>=0 || (r.title||'').toLowerCase().indexOf(q)>=0; });
    var key = (sortBy.value||'total');
    arr.sort(function(a,b){
      if (key==='front') return (b.frontGross||0) - (a.frontGross||0);
      if (key==='back') return (b.backGross||0) - (a.backGross||0);
      if (key==='payment') return (a.monthlyPayment||0) - (b.monthlyPayment||0);
      return (b.totalGross||0) - (a.totalGross||0);
    });
    grid.innerHTML = '';
    for (var i=0;i<arr.length;i++){
      var row = arr[i];
      var card = document.createElement('div');
      card.className = 'card';

      var img = document.createElement('img');
      img.src = row.imageUrl || '';
      img.alt = row.title || '';
      card.appendChild(img);

      var body = document.createElement('div');
      body.className = 'body';
      body.innerHTML =
        '<div class="row"><div>' + (row.title||'') + '</div><div class="chip">' + (row.vin||'') + '</div></div>' +
        '<div class="row"><div>Sale Price</div><div>' + fmt$(row.salePrice) + '</div></div>' +
        '<div class="row"><div>Payment</div><div>' + fmt$(row.monthlyPayment) + '/mo</div></div>' +
        '<div class="row"><div>Front</div><div>' + fmt$(row.frontGross) + '</div></div>' +
        '<div class="row"><div>Back</div><div>' + fmt$(row.backGross) + '</div></div>' +
        '<div class="row gross"><div>Total Gross</div><div>' + fmt$(row.totalGross) + '</div></div>' +
        '<div class="flags">' + ((row.flags||[]).join(', ')) + '</div>';

      var pushBtn = document.createElement('button');
      pushBtn.className = 'btn primary';
      pushBtn.textContent = 'Push to GHL';
      pushBtn.onclick = (function(r){ return async function(){
        var payload = { contactId: (lastApproval && lastApproval.contactId) || '', selected: r };
        var resp = await fetch('/api/ghl/push-selected', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        var jj = await resp.json();
        toast(jj.success ? 'Pushed to GHL' : ('Push failed: ' + (jj.error || 'unknown')));
      };})(row);
      body.appendChild(pushBtn);

      var detBtn = document.createElement('button');
      detBtn.className = 'btn';
      detBtn.textContent = 'Details';
      detBtn.style.marginLeft = '8px';
      detBtn.onclick = (function(r){ return function(){ openDetails(r); };})(row);
      body.appendChild(detBtn);

      var upBtn = document.createElement('button');
      upBtn.className = 'btn';
      upBtn.textContent = 'Upload Photo';
      upBtn.style.marginLeft = '8px';
      upBtn.onclick = (function(r, imgEl){ return function(){
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async function(){
          if (!input.files || !input.files[0]) { return; }
          var fd = new FormData();
          fd.append('file', input.files[0]);
          if (r.vin) fd.append('vin', r.vin);
          if (r.vehicleId) fd.append('id', String(r.vehicleId));
          var resp = await fetch('/api/inventory/upload-image', { method:'POST', body: fd });
          var jr = await resp.json();
          if (jr && jr.success) {
            var nextSrc = r.vin ? ('/api/inventory/image-by-vin/' + encodeURIComponent(r.vin)) : (r.vehicleId ? ('/api/inventory/image/' + encodeURIComponent(String(r.vehicleId))) : '');
            if (nextSrc) { imgEl.src = nextSrc + '?t=' + Date.now(); }
            toast('Photo uploaded');
          } else {
            toast('Photo upload failed: ' + (jr && jr.error || 'unknown'));
          }
        };
        input.click();
      };})(row, img);
      body.appendChild(upBtn);

      card.appendChild(body);
      grid.appendChild(card);
    }
  }

  async function refreshMeta(){
    try {
      var r = await fetch('/api/inventory');
      var j = await r.json();
      currentInventory = Array.isArray(j.vehicles) ? j.vehicles : [];
      var inv = j && j.total != null ? j.total : 0;
      meta.textContent = '';
      var span = document.createElement('span');
      span.className = 'chip';
      span.textContent = inv + ' vehicles loaded';
      meta.appendChild(span);
    } catch (e) { }
  }

  async function loadApproval(){
    meta.textContent = 'Loading approval...';
    var r = await fetch('/api/approvals/last');
    var j = await r.json();
    if (!j.hasApproval) { meta.textContent = 'No approval ingested yet. Trigger your GHL workflow.'; return; }
    lastApproval = j.lastApproval;
    var a = lastApproval.approval;
    meta.innerHTML = '<span class="chip">' + a.bank + '</span> <span class="chip">' + a.program + '</span> <span class="chip">' + a.termMonths + ' mo</span> <span class="chip">' + a.apr + '%</span> <span class="chip">$' + a.paymentMin + ' - $' + a.paymentMax + '</span>';
    document.getElementById('score').disabled = false;
    toast('Approval loaded');
  }

  async function score(){
    grid.innerHTML = '';
    meta.insertAdjacentHTML('beforeend', '<div style="margin-top:6px;color:var(--muted)">Scoring inventory...</div>');
    var r = await fetch('/api/approvals/score', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
    var j = await r.json();
    if (!j.success) { grid.textContent = 'Error: ' + (j.error || 'unknown'); return; }
    currentRows = j.rows || [];
    renderRows();
  }

  document.getElementById('load').onclick = loadApproval;
  document.getElementById('score').onclick = score;
  document.getElementById('uploadInventory').onclick = function(){ openInventory(); };
  document.getElementById('uploadRules').onclick = function(){ openRules(); };
  document.getElementById('uploadApproval').onclick = function(){ openApproval(); };
  var scrapeBtn = document.getElementById('scrapeDevon');
  if (scrapeBtn) scrapeBtn.onclick = async function(){
    try {
      scrapeBtn.disabled = true;
      meta.textContent = 'Scraping Devon Chrysler inventory (used + new)...';
      var usedPath = 'https://www.devonchrysler.com/search/used-devon-ab/?cy=t9g_1b2&tp=used';
      var newPath = 'https://www.devonchrysler.com/search/new-chrysler-dodge-jeep-ram-devon-ab/?cy=t9g_1b2&tp=new';
      var u = await fetch('/api/scrape/devon?limit=200&path=' + encodeURIComponent(usedPath));
      var ju = await u.json();
      if (!ju.success) { toast('Used scrape failed: ' + (ju.error||'unknown')); }
      var n = await fetch('/api/scrape/devon?limit=200&path=' + encodeURIComponent(newPath));
      var jn = await n.json();
      if (!jn.success) { toast('New scrape failed: ' + (jn.error||'unknown')); }
      var all = ([]).concat((ju.vehicles||[]),(jn.vehicles||[]));
      // dedupe by VIN or id
      var seen = {};
      var vehicles = [];
      for (var i=0;i<all.length;i++){
        var key = (all[i].vin||'') + '|' + (all[i].id||'');
        if (!seen[key]) { seen[key]=true; vehicles.push(all[i]); }
      }
      var ok = 0;
      for (var i2=0;i2<vehicles.length;i2++){
        var v = vehicles[i2];
        try {
          var payload = {
            id: v.id || v.stock_number || v.vin || ('SCR-' + i2),
            vin: v.vin,
            year: v.year,
            make: v.make,
            model: v.model,
            mileage: v.mileage,
            price: v.suggestedPrice || v.price,
            suggestedPrice: v.suggestedPrice || v.price,
            imageUrl: v.imageUrl || v.image_url,
            inStock: true
          };
          var rr = await fetch('/api/inventory/sync', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          var jr = await rr.json();
          if (jr && jr.success) ok++;
        } catch(_e){}
      }
      await refreshMeta();
      renderInventoryTable();
      toast('Imported ' + ok + ' vehicles');
      meta.textContent = '';
    } catch(e){ toast('Scrape error'); }
    finally { scrapeBtn.disabled = false; }
  };
  document.getElementById('closeRules').onclick = function(){ closeRules(); };
  document.getElementById('closeApproval').onclick = function(){ closeApproval(); };
  document.getElementById('closeInventory').onclick = function(){ closeInventory(); };
  try { console.log('dashboard: handlers bound'); } catch(_e) {}

  document.getElementById('loadSample').onclick = function(){
    var sample = '[\n  {\n    "bank": "EdenPark",\n    "program": "Ride 5",\n    "frontCapFactor": 1.40,\n    "reserve": {\n      "fixedByFinancedAmount": [\n        { "minFinanced": 45001, "maxFinanced": 999999, "amount": 750 }\n      ]\n    },\n    "maxPayCall": 950\n  }\n]';
    rulesInput.value = sample;
  };

  document.getElementById('saveRules').onclick = async function(){
    var txt = (rulesInput.value||'').trim();
    if (!txt && fileTextCache) txt = fileTextCache;
    if (!txt) { toast('Provide JSON via text or file'); return; }
    var body;
    try { body = JSON.parse(txt); } catch(e) { toast('Invalid JSON'); return; }
    var resp = await fetch('/api/rules/upload', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    var jr = await resp.json();
    if (jr.success) { toast('Rules loaded: ' + jr.total); closeRules(); }
    else { toast('Failed: ' + (jr.error||'unknown')); }
  };

  rulesFile.onchange = function(){
    var f = rulesFile.files && rulesFile.files[0];
    if (!f) return; var reader = new FileReader();
    reader.onload = function(){ fileTextCache = String(reader.result||''); rulesInput.value = fileTextCache; };
    reader.readAsText(f);
  };

  if (parseRulesPdf) parseRulesPdf.onclick = async function(){
    if (!rulesPdf || !rulesPdf.files || !rulesPdf.files[0]) { toast('Select a rules PDF'); return; }
    var fd = new FormData(); fd.append('file', rulesPdf.files[0]);
    var resp = await fetch('/api/rules/parse-pdf', { method:'POST', body: fd });
    var jr = await resp.json();
    if (jr.success) { rulesInput.value = jr.text || ''; toast('Parsed rules PDF'); }
    else { toast('Failed: ' + (jr.error||'unknown')); }
  };

  document.getElementById('saveInventory').onclick = async function(){
    var txt = (inventoryText.value||'').trim();
    if (!txt && invFileTextCache) txt = invFileTextCache;
    if (!txt) { toast('Provide CSV via text or file'); return; }
    var resp = await fetch('/api/inventory/upload', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ csvContent: txt }) });
    var jr = await resp.json();
    if (jr.success) { toast(jr.message || 'Inventory uploaded'); closeInventory(); await refreshMeta(); renderInventoryTable(); inventorySection.classList.remove('hidden'); }
    else { toast('Failed: ' + (jr.error||'unknown')); }
  };

  inventoryFile.onchange = function(){
    var f = inventoryFile.files && inventoryFile.files[0];
    if (!f) return; var reader = new FileReader();
    reader.onload = function(){ invFileTextCache = String(reader.result||''); inventoryText.value = invFileTextCache; };
    reader.readAsText(f);
  };

  if (saveInventoryFile) saveInventoryFile.onclick = async function(){
    if (!inventoryFile || !inventoryFile.files || !inventoryFile.files[0]) { toast('Select a CSV file'); return; }
    var fd = new FormData(); fd.append('file', inventoryFile.files[0]);
    var resp = await fetch('/api/inventory/upload-file', { method:'POST', body: fd });
    var jr = await resp.json();
    if (jr.success) { toast(jr.message || 'Inventory uploaded'); closeInventory(); await refreshMeta(); renderInventoryTable(); inventorySection.classList.remove('hidden'); }
    else { toast('Failed: ' + (jr.error||'unknown')); }
  };

  if (parseInventoryPdf) parseInventoryPdf.onclick = async function(){
    if (!inventoryPdf || !inventoryPdf.files || !inventoryPdf.files[0]) { toast('Select a PDF'); return; }
    var fd = new FormData(); fd.append('file', inventoryPdf.files[0]);
    var resp = await fetch('/api/inventory/parse-pdf', { method:'POST', body: fd });
    var jr = await resp.json();
    if (jr.success) { inventoryText.value = jr.text || ''; toast('Parsed inventory PDF'); }
    else { toast('Failed: ' + (jr.error||'unknown')); }
  };

  document.getElementById('saveApproval').onclick = async function(){
    var txt = (approvalText.value||'').trim();
    if (!txt) { toast('Provide approval JSON'); return; }
    var body;
    try { body = JSON.parse(txt); } catch(e) { toast('Invalid JSON'); return; }
    var resp = await fetch('/api/approvals/ingest', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    var jr = await resp.json();
    if (jr.success) { toast('Approval ingested'); closeApproval(); await loadApproval(); }
    else { toast('Failed: ' + (jr.error||'unknown')); }
  };

  if (parseApprovalPdf) parseApprovalPdf.onclick = async function(){
    if (!approvalPdf || !approvalPdf.files || !approvalPdf.files[0]) { toast('Select an approval PDF'); return; }
    var fd = new FormData(); fd.append('file', approvalPdf.files[0]);
    var resp = await fetch('/api/approvals/parse-pdf', { method:'POST', body: fd });
    var jr = await resp.json();
    if (jr.success) {
      if (jr.suggestion) { try { approvalText.value = JSON.stringify(jr.suggestion, null, 2); } catch(_e) { approvalText.value = String(jr.text||''); } }
      else { approvalText.value = String(jr.text||''); }
      toast('Parsed approval PDF');
    } else { toast('Failed: ' + (jr.error||'unknown')); }
  };

  sortBy.onchange = renderRows; search.oninput = function(){ renderRows(); };

  function renderInventoryTable(){
    try {
      var tbody = inventoryTable.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      for (var i=0; i<currentInventory.length; i++){
        var v = currentInventory[i];
        var tr = document.createElement('tr');
        function td(txt){ var d=document.createElement('td'); d.textContent = txt; return d; }
        tr.appendChild(td(v.id||''));
        tr.appendChild(td(v.vin||''));
        tr.appendChild(td(String(v.year||'')));
        tr.appendChild(td(v.make||''));
        tr.appendChild(td(v.model||''));
        tr.appendChild(td(fmt$(v.yourCost)));
        tr.appendChild(td(fmt$(v.suggestedPrice)));
        var bb = v.blackBookValue!=null? ('$'+Number(v.blackBookValue).toLocaleString()):''; tr.appendChild(td(bb));
        tr.appendChild(td((v.cbbWholesale||0) + ' / ' + (v.cbbRetail||0)));
        var imgTd = document.createElement('td');
        var img = document.createElement('img'); img.style.width='48px'; img.style.height='32px'; img.style.objectFit='cover'; img.src = v.imageUrl || ''; img.alt='';
        imgTd.appendChild(img); tr.appendChild(imgTd);
        var act = document.createElement('td');
        var b1 = document.createElement('button'); b1.className='btn'; b1.textContent='Details'; b1.onclick=(function(vv){ return function(){
          // try find a scored row by vin/id for payment/gross
          var r = currentRows.find(function(x){ return x.vin===vv.vin || String(x.vehicleId)===String(vv.id); });
          if (r) openDetails(r); else {
            // synthesize a minimal row-like object for details
            openDetails({ vin: vv.vin, title: vv.year+' '+vv.make+' '+vv.model, salePrice: vv.suggestedPrice, monthlyPayment: 0, frontGross: 0, backGross: 0, totalGross: 0, flags: [], vehicleId: vv.id, imageUrl: vv.imageUrl });
          }
        };})(v);
        act.appendChild(b1);
        var b2 = document.createElement('button'); b2.className='btn'; b2.textContent='Upload Photo'; b2.style.marginLeft='8px'; b2.onclick=(function(vv, imgEl){ return function(){
          var input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.onchange = async function(){
            if (!input.files || !input.files[0]) { return; }
            var fd = new FormData();
            fd.append('file', input.files[0]);
            if (vv.vin) fd.append('vin', vv.vin);
            if (vv.id) fd.append('id', String(vv.id));
            var resp = await fetch('/api/inventory/upload-image', { method:'POST', body: fd });
            var jr = await resp.json();
            if (jr && jr.success) {
              var nextSrc = vv.vin ? ('/api/inventory/image-by-vin/' + encodeURIComponent(vv.vin)) : (vv.id ? ('/api/inventory/image/' + encodeURIComponent(String(vv.id))) : '');
              if (nextSrc) { imgEl.src = nextSrc + '?t=' + Date.now(); }
              toast('Photo uploaded');
            } else {
              toast('Photo upload failed: ' + (jr && jr.error || 'unknown'));
            }
          };
          input.click();
        };})(v, img);
        act.appendChild(b2);
        var b3 = document.createElement('button'); b3.className='btn'; b3.textContent='Set BB'; b3.style.marginLeft='8px'; b3.onclick=(function(vv){ return async function(){
          try {
            var val = prompt('Enter Black Book value for '+ (vv.vin||vv.id) + ' (numbers only, e.g. 45250):', vv.blackBookValue!=null? String(vv.blackBookValue):'');
            if (val===null) return; // cancel
            var clean = String(val).replace(/[$,\s]/g,'');
            var num = parseFloat(clean);
            if (isNaN(num)) { toast('Invalid number'); return; }
            var resp = await fetch('/api/inventory/sync', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: vv.id, blackBookValue: num }) });
            var jr = await resp.json();
            if (jr.success) { vv.blackBookValue = num; renderInventoryTable(); toast('Black Book updated'); }
            else { toast('Update failed: ' + (jr.error||'unknown')); }
          } catch(e){ toast('Update failed'); }
        };})(v);
        act.appendChild(b3);
        tr.appendChild(act);
        tbody.appendChild(tr);
      }
    } catch(_e){}
  }

  function openDetails(row){
    try {
      var v = currentInventory.find(function(x){ return x.vin===row.vin || String(x.id)===String(row.vehicleId); }) || {};
      var html = '';
      html += '<div style="display:flex; gap:12px; align-items:flex-start;">';
      html += '<img src="' + (row.imageUrl||v.imageUrl||'') + '" style="width:180px;height:120px;object-fit:cover;border:1px solid var(--border);border-radius:8px;" />';
      html += '<div>';
      html += '<div style="font-weight:700;font-size:16px;">' + (row.title|| (v.year+' '+(v.make||'')+' '+(v.model||''))) + '</div>';
      html += '<div class="chip">' + (row.vin||v.vin||'') + '</div>';
      html += '<div style="margin-top:8px;color:var(--muted)">Sale Price: ' + fmt$(row.salePrice) + ' • Payment: ' + fmt$(row.monthlyPayment) + '/mo</div>';
      html += '<div style="margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;">';
      html += '<div>Front Gross</div><div style="text-align:right;">' + fmt$(row.frontGross) + '</div>';
      html += '<div>Back Gross</div><div style="text-align:right;">' + fmt$(row.backGross) + '</div>';
      html += '<div>Total Gross</div><div style="text-align:right;font-weight:700;">' + fmt$(row.totalGross) + '</div>';
      html += '<div>Your Cost</div><div style="text-align:right;">' + fmt$(v.yourCost) + '</div>';
      html += '<div>Black Book</div><div style="text-align:right;">' + (v.blackBookValue!=null?fmt$(v.blackBookValue):'') + '</div>';
      html += '<div>CBB Wholesale/Retail</div><div style="text-align:right;">' + (v.cbbWholesale||0) + ' / ' + (v.cbbRetail||0) + '</div>';
      html += '</div>';
      if (row.flags && row.flags.length){ html += '<div style="margin-top:8px;color:var(--danger)">' + row.flags.join(', ') + '</div>'; }
      html += '</div>';
      html += '</div>';
      detailsContent.innerHTML = html;
      detailsModal.classList.remove('hidden');
    } catch(_e){}
  }

  if (closeDetails) closeDetails.onclick = function(){ try { detailsModal.classList.add('hidden'); } catch(_e){} };
  if (toggleInventoryBtn) toggleInventoryBtn.onclick = async function(){
    var showing = !inventorySection.classList.contains('hidden');
    if (showing) { inventorySection.classList.add('hidden'); }
    else {
      if (!currentInventory || !currentInventory.length) { await refreshMeta(); }
      renderInventoryTable();
      inventorySection.classList.remove('hidden');
    }
  };

  refreshMeta();
  try { console.log('dashboard: init complete'); } catch(_e) {}
})();
</file>

<file path="package.json">
{
    "name": "finance-in-box",
    "version": "1.0.0",
    "description": "Complete TypeScript financial system for Canadian automotive dealerships",
    "main": "dist/server.js",
    "scripts": {
        "build": "tsc",
        "postinstall": "npm run build",
        "start": "node dist/server.js",
        "dev": "set NEW_PORT=10001&& ts-node src/server.ts",
        "test": "jest",
        "typecheck": "tsc --noEmit",
        "test:watch": "jest --watch"
    },
    "dependencies": {
        "@supabase/supabase-js": "^2.45.2",
        "axios": "^1.13.2",
        "cheerio": "^1.0.0-rc.12",
        "puppeteer": "^22.10.0",
        "cors": "^2.8.5",
        "dotenv": "^16.0.3",
        "express": "^4.18.2",
        "multer": "^1.4.5-lts.2",
        "pdf-parse": "^1.1.1",
        "winston": "^3.11.0"
    },
    "devDependencies": {
        "@types/cors": "^2.8.19",
        "@types/express": "^4.17.17",
        "@types/jest": "^29.2.4",
        "@types/multer": "^2.0.0",
        "@types/node": "^18.11.9",
        "jest": "^29.3.1",
        "ts-jest": "^29.0.3",
        "ts-node": "^10.9.1",
        "typescript": "^4.9.4"
    }
}
</file>

</files>
